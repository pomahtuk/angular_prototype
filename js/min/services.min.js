(function(){"use strict";angular.module("Museum.services",[]).service("sharedProperties",function(e){var t;return t={},{getProperty:function(e){return t[e]},setProperty:function(r,i){return t[r]=i,e.$broadcast("exhibitChange")}}}).service("storySetValidation",function(e,t){return{checkValidity:function(t){return null==t.item.images&&(t.item.images=[]),null==t.item.long_description&&(t.item.long_description=""),0!==t.item.long_description.length&&t.item.audio&&null!=t.root.number&&t.root.images.length>=1?(this.markValid(t),e.$broadcast("changes_to_save",t)):this.markInvalid(t)},markInvalid:function(r){return console.log("invalid"),"published"===r.item.status?(r.root.invalid=!0,t(function(){return r.item.status="passcode",null!=r.$digest&&r.$digest(),e.$broadcast("changes_to_save",r)},100)):e.$broadcast("changes_to_save",r)},markValid:function(e){return console.log("valid"),e.root.invalid=!1}}}).service("imageMappingHelpers",function(e,t,r,i){var s;return s=function(t){var r;return r=0,r+=t.image.order,null!=t.mappings[e.lang]&&(r-=100),r},{sort_weight_func:function(e,t){return s(e)>s(t)?1:s(e)<s(t)?-1:0},sort_time_func:function(t,r){if(null!=t.mappings[e.lang]&&null!=r.mappings[e.lang]&&t.mappings[e.lang].timestamp>=0){if(t.mappings[e.lang].timestamp>r.mappings[e.lang].timestamp)return 1;if(t.mappings[e.lang].timestamp<r.mappings[e.lang].timestamp)return-1}return 0},calc_timestamp:function(e,t){var r,i,s,a,n,o,u,c,l;return null==t&&(t=!1),c=$(".jp-seek-bar:visible"),n=$(".jp-duration:visible"),o=$(".jp-play:visible"),i=t?e.offset.left-c.offset().left:e.position.left-o.width(),r=c.width()-15,a=n.text(),l=parseInt(a.split(":")[1],10)+60*parseInt(a.split(":")[0],10),u=l/r,s=Math.round(i*u),0>=s&&(s=0),s},update_image:function(s,a){return r.put(""+a+"/media/"+s.image._id,s.image).success(function(){var n;return console.log("ok"),null!=s.mappings[e.lang]&&(n=s.mappings[e.lang],null!=n._id)?r.put(""+a+"/media_mapping/"+n._id,n).success(function(){return console.log("ok")}).error(function(){return t.addError(i("Failed to set timestamp"))}):void 0}).error(function(){return t.addError(i("Failed to set timestamp"))}),!0},update_images:function(e,s,a){return r.post(""+a+"/media_for/"+e+"/reorder",s).success(function(){return console.log("ok")}).error(function(){return t.addError(i("Failed to update order"))}),!0},create_mapping:function(s,a){return r.post(""+a+"/media_mapping/",s.mappings[e.lang]).success(function(t){return s.mappings[e.lang]=t}).error(function(){return t.addError(i("Failed to set timestamp"))}),!0}}}).service("uploadHelpers",function(){return{cavas_processor:function(e,t){var r;return null==t&&(t="image/jpeg"),console.log("called"),r=document.createElement("canvas"),r.width=e.width,r.height=e.height,r.getContext&&r.toBlob&&(r.getContext("2d").drawImage(e,0,0,e.width,e.height),r.toBlob(function(e){var t;return t=$("#drop_down, #museum_drop_down").filter(":visible").find("input[type=file]"),t.fileupload("add",{files:[e]})},t)),!0}}}).service("errorProcessing",function(e){return{errors:[],addError:function(t){var r;return r={error:t},this.errors.push(r),e.$broadcast("new_error",this.errors)},getErrors:function(){return this.errors},clearErrors:function(){return this.errors=[],e.$broadcast("new_error",this.errors)},deleteError:function(t){return this.errors.splice(t,1),e.$broadcast("new_error",this.errors)}}}).service("backendWrapper",function(e,t,r,i){return{museum_id:"528f05b3c99772031a000002",content_provider_id:"528f05b3c99772031a000001",backend_url:"http://prototype.izi.travel/api",museums:[],exhibits:[],modal_translations:[],langs:[],current_museum:{},active_exhibit:{},sort_field:"number",sort_direction:1,ajax_progress:!0,grouped_positions:{},reload_exhibits:function(r,i,s){var a;return null==r&&(r=r),null==i&&(i=i),a=e.get(""+this.backend_url+"/provider/"+this.content_provider_id+"/museums/"+this.museum_id+"/exhibits/"+this.sort_field+"/"+this.sort_direction),a.success(function(e){var r,i,a,n,o,u,c,l,d,m,g,p,h,f,_,b;for(n=[],u=0,m=e.length;m>u;u++)if(a=e[u],null!=a){for(r=a.exhibit,r.images=[],r.mapped_images=[],r.cover={},f=a.images,c=0,g=f.length;g>c;c++)i=f[c],r.images.push(i),i.image.cover===!0&&(r.cover=i.image);for(r.stories={},_=a.stories,l=0,p=_.length;p>l;l++){for(o=_[l],o.story.quiz=o.quiz.quiz,o.story.audio=o.audio,o.story.video=o.video,o.story.quiz.answers=o.quiz.answers,o.story.mapped_images=[],b=r.images,d=0,h=b.length;h>d;d++)i=b[d],i.mappings[o.story.language]&&o.story.mapped_images.push(i);r.stories[o.story.language]=o.story}n.push(r)}return t.complete(),console.log("anim completed"),this.active_exhibit=n[0],this.exhibits=n,this.ajax_progress=!1,0===n.length&&(this.active_exhibit={index:0,name:"Богоматерь Владимирская, с двунадесятыми праздниками",number:"1",image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",publish_state:"all",description:"",qr_code:{url:"/img/qr_code.png",print_link:"http://localhost:8000/img/qr_code.png"},images:[{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:1,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"},{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:2,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"}],stories:{ru:{name:"Богоматерь Владимирская, с двунадесятыми праздниками",description:"test description",publish_state:"all",audio:"http://www.jplayer.org/audio/ogg/TSP-01-Cro_magnon_man.ogg",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}}}}),null!=s?s.resolve():void 0}.bind(this)),a.error(function(){return t.complete(),null!=s?s.reject():void 0})},fetch_data:function(r,s){var a;return t.color("#fd6e3b"),t.start(),console.log("anim started",r),null!=r&&(this.museum_id=r),a=e.get(""+this.backend_url+"/provider/"+this.content_provider_id+"/museums"),a.success(function(e){var t,r,a,n,o,u,c,l,d,m,g,p,h,f,_,b,v,y,x,w;for(this.museums=[],t=!1,this.langs=[],this.modal_translations={},c=0,g=e.length;g>c;c++){for(a=e[c],o=a.exhibit,o.def_lang="ru",null==o.language&&(o.language="ru"),o.package_status="process",o.stories={},o.images=[],o.mapped_images=[],o.cover={},v=a.images,l=0,p=v.length;p>l;l++)r=v[l],o.images.push(r),r.image.cover===!0&&(o.cover=r.image);for(y=a.stories,d=0,h=y.length;h>d;d++){for(u=y[d],u.story.city="Saint-Petersburg",u.story.quiz=u.quiz.quiz,u.story.audio=u.audio,u.story.video=u.video,u.story.quiz.answers=u.quiz.answers,u.story.mapped_images=[],x=o.images,m=0,f=x.length;f>m;m++)r=x[m],r.mappings[u.story.language]&&u.story.mapped_images.push(r);o.stories[u.story.language]=u.story,this.langs.push(u.story.language)}this.museums.push(o),o.active=!1,o._id===this.museum_id&&(o.active=!0,this.current_museum=o,t=!0),this.langs.unique()}for(t||(this.current_museum=this.museums[0],this.current_museum.def_lang="ru",null==o.language&&(this.current_museum.language="ru"),this.museum_id=this.current_museum._id),w=this.langs,b=0,_=w.length;_>b;b++)n=w[b],this.modal_translations[n]={name:i(n)};return this.reload_exhibits(null,null,s)}.bind(this)),a.error(function(){return t.complete(),null!=s?s.reject():void 0})}}})}).call(this);