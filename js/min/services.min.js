(function(){"use strict";angular.module("Museum.services",[]).service("sharedProperties",function(e){var r;return r={},{getProperty:function(e){return r[e]},setProperty:function(t,i){return r[t]=i,e.$broadcast("exhibitChange")}}}).service("storySetValidation",function(e,r){return{checkValidity:function(r){return null==r.item.images&&(r.item.images=[]),null==r.item.long_description&&(r.item.long_description=""),0!==r.item.long_description.length&&r.item.audio&&null!=r.root.number&&r.root.images.length>=1?(this.markValid(r),e.$broadcast("changes_to_save",r)):this.markInvalid(r)},markInvalid:function(t){return console.log("invalid"),"published"===t.item.status?(t.root.invalid=!0,r(function(){return t.item.status="passcode",null!=t.$digest&&t.$digest(),e.$broadcast("changes_to_save",t)},100)):e.$broadcast("changes_to_save",t)},markValid:function(e){return console.log("valid"),e.root.invalid=!1}}}).service("imageMappingHelpers",function(e,r,t,i){var s;return s=function(r){var t;return t=0,t+=r.image.order,null!=r.mappings[e.lang]&&(t-=100),t},{sort_weight_func:function(e,r){return s(e)>s(r)?1:s(e)<s(r)?-1:0},sort_time_func:function(r,t){if(null!=r.mappings[e.lang]&&null!=t.mappings[e.lang]&&r.mappings[e.lang].timestamp>=0){if(r.mappings[e.lang].timestamp>t.mappings[e.lang].timestamp)return 1;if(r.mappings[e.lang].timestamp<t.mappings[e.lang].timestamp)return-1}return 0},calc_timestamp:function(e,r){var t,i,s,n,o,a,u,l,m;return null==r&&(r=!1),l=$(".jp-seek-bar:visible"),o=$(".jp-duration:visible"),a=$(".jp-play:visible"),i=r?e.offset.left-l.offset().left:e.position.left-a.width(),t=l.width()-15,n=o.text(),m=parseInt(n.split(":")[1],10)+60*parseInt(n.split(":")[0],10),u=m/t,s=Math.round(i*u),0>=s&&(s=0),s},update_image:function(s,n){return t.put(""+n+"/media/"+s.image._id,s.image).success(function(){var o;return console.log("ok"),null!=s.mappings[e.lang]&&(o=s.mappings[e.lang],null!=o._id)?t.put(""+n+"/media_mapping/"+o._id,o).success(function(){return console.log("ok")}).error(function(){return r.addError(i("Failed to set timestamp"))}):void 0}).error(function(){return r.addError(i("Failed to set timestamp"))}),!0},update_images:function(e,s,n){return t.post(""+n+"/media_for/"+e+"/reorder",s).success(function(){return console.log("ok")}).error(function(){return r.addError(i("Failed to update order"))}),!0},create_mapping:function(s,n){return t.post(""+n+"/media_mapping/",s.mappings[e.lang]).success(function(r){return s.mappings[e.lang]=r}).error(function(){return r.addError(i("Failed to set timestamp"))}),!0}}}).service("uploadHelpers",function(){return{cavas_processor:function(e,r){var t;return null==r&&(r="image/jpeg"),console.log("called"),t=document.createElement("canvas"),t.width=e.width,t.height=e.height,t.getContext&&t.toBlob&&(t.getContext("2d").drawImage(e,0,0,e.width,e.height),t.toBlob(function(e){var r;return r=$("#drop_down, #museum_drop_down").filter(":visible").find("input[type=file]"),r.fileupload("add",{files:[e]})},r)),!0}}}).service("errorProcessing",function(e){return{errors:[],addError:function(r){var t;return t={error:r},this.errors.push(t),e.$broadcast("new_error",this.errors)},getErrors:function(){return this.errors},clearErrors:function(){return this.errors=[],e.$broadcast("new_error",this.errors)},deleteError:function(r){return this.errors.splice(r,1),e.$broadcast("new_error",this.errors)}}}).service("backendWrapper",function(e,r,t,i){return{museum_id:"528f05b3c99772031a000002",content_provider_id:"528f05b3c99772031a000001",backend_url:"http://prototype.izi.travel/api",museums:[],exhibits:[],modal_translations:[],langs:[],current_museum:{},active_exhibit:{},sort_field:"number",sort_direction:1,ajax_progress:!0,grouped_positions:{},reload_exhibits:function(t,i,s){var n;return null==t&&(t=t),null==i&&(i=i),n=e.get(""+this.backend_url+"/provider/"+this.content_provider_id+"/museums/"+this.museum_id+"/exhibits/"+this.sort_field+"/"+this.sort_direction),n.success(function(e){var t,i,n,o,a,u,l,m,c,d,g,p,h,_,f,v;for(o=[],u=0,d=e.length;d>u;u++)if(n=e[u],null!=n){for(t=n.exhibit,t.images=[],t.mapped_images=[],t.cover={},_=n.images,l=0,g=_.length;g>l;l++)i=_[l],t.images.push(i),i.image.cover===!0&&(t.cover=i.image);for(t.stories={},f=n.stories,m=0,p=f.length;p>m;m++){for(a=f[m],a.story.quiz=a.quiz.quiz,a.story.audio=a.audio,a.story.video=a.video,a.story.quiz.answers=a.quiz.answers,a.story.mapped_images=[],v=t.images,c=0,h=v.length;h>c;c++)i=v[c],i.mappings[a.story.language]&&a.story.mapped_images.push(i);t.stories[a.story.language]=a.story}o.push(t)}return r.complete(),console.log("anim completed"),this.active_exhibit=o[0],this.exhibits=o,this.ajax_progress=!1,null!=s?s.resolve():void 0}.bind(this)),n.error(function(){return r.complete(),null!=s?s.reject():void 0})},fetch_data:function(t,s){var n;return r.color("#fd6e3b"),r.start(),console.log("anim started",t),null!=t&&(this.museum_id=t),n=e.get(""+this.backend_url+"/provider/"+this.content_provider_id+"/museums"),n.success(function(e){var r,n,o,a,u,l,m,c,d,g,p,h,_,f,v,b,y,w,x,k;for(this.museums=[],r=!1,this.langs=[],this.modal_translations={},m=0,p=e.length;p>m;m++){for(o=e[m],u=o.exhibit,u.def_lang="ru",null==u.language&&(u.language="ru"),u.package_status="process",u.stories={},u.images=[],u.mapped_images=[],u.cover={},y=o.images,c=0,h=y.length;h>c;c++)n=y[c],u.images.push(n),n.image.cover===!0&&(u.cover=n.image);for(w=o.stories,d=0,_=w.length;_>d;d++){for(l=w[d],l.story.city="Saint-Petersburg",l.story.quiz=l.quiz.quiz,l.story.audio=l.audio,l.story.video=l.video,l.story.quiz.answers=l.quiz.answers,l.story.mapped_images=[],x=u.images,g=0,f=x.length;f>g;g++)n=x[g],n.mappings[l.story.language]&&l.story.mapped_images.push(n);u.stories[l.story.language]=l.story,this.langs.push(l.story.language)}this.museums.push(u),u.active=!1,console.log("comparing ids",t,u._id),u._id===this.museum_id&&(u.active=!0,this.current_museum=u,r=!0),this.langs.unique()}for(r||(this.current_museum=this.museums[0],this.current_museum.def_lang="ru",null==u.language&&(this.current_museum.language="ru"),this.museum_id=this.current_museum._id),k=this.langs,b=0,v=k.length;v>b;b++)a=k[b],this.modal_translations[a]={name:i(a)};return this.reload_exhibits(null,null,s)}.bind(this)),n.error(function(){return r.complete(),null!=s?s.reject():void 0})}}})}).call(this);