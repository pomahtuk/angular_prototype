(function(){"use strict";angular.module("Museum.services",[]).service("sharedProperties",function(e){var t;return t={},{getProperty:function(e){return t[e]},setProperty:function(r,i){return t[r]=i,e.$broadcast("exhibitChange")}}}).service("storySetValidation",function(e,t){return{checkValidity:function(t){return null==t.item.images&&(t.item.images=[]),null==t.item.long_description&&(t.item.long_description=""),0!==t.item.long_description.length&&t.item.audio&&null!=t.root.number&&t.root.images.length>=1?(this.markValid(t),e.$broadcast("changes_to_save",t)):this.markInvalid(t)},markInvalid:function(r){return console.log("invalid"),"published"===r.item.status?(r.root.invalid=!0,t(function(){return r.item.status="passcode",null!=r.$digest&&r.$digest(),e.$broadcast("changes_to_save",r)},100)):e.$broadcast("changes_to_save",r)},markValid:function(e){return console.log("valid"),e.root.invalid=!1}}}).service("imageMappingHelpers",function(e,t,r,i){var a;return a=function(t){var r;return r=0,r+=t.image.order,null!=t.mappings[e.lang]&&(r-=100),r},{sort_weight_func:function(e,t){return a(e)>a(t)?1:a(e)<a(t)?-1:0},sort_time_func:function(t,r){if(null!=t.mappings[e.lang]&&null!=r.mappings[e.lang]&&t.mappings[e.lang].timestamp>=0){if(t.mappings[e.lang].timestamp>r.mappings[e.lang].timestamp)return 1;if(t.mappings[e.lang].timestamp<r.mappings[e.lang].timestamp)return-1}return 0},calc_timestamp:function(e,t){var r,i,a,n,o,s,u,c,l;return null==t&&(t=!1),c=$(".jp-seek-bar:visible"),o=$(".jp-duration:visible"),s=$(".jp-play:visible"),i=t?e.offset.left-c.offset().left:e.position.left-s.width(),r=c.width()-15,n=o.text(),l=parseInt(n.split(":")[1],10)+60*parseInt(n.split(":")[0],10),u=l/r,a=Math.round(i*u),0>=a&&(a=0),a},update_image:function(a,n){return r.put(""+n+"/media/"+a.image._id,a.image).success(function(){var o;return console.log("ok"),null!=a.mappings[e.lang]&&(o=a.mappings[e.lang],null!=o._id)?r.put(""+n+"/media_mapping/"+o._id,o).success(function(){return console.log("ok")}).error(function(){return t.addError(i("Failed to set timestamp"))}):void 0}).error(function(){return t.addError(i("Failed to set timestamp"))}),!0},update_images:function(e,a,n){return r.post(""+n+"/media_for/"+e+"/reorder",a).success(function(){return console.log("ok")}).error(function(){return t.addError(i("Failed to update order"))}),!0},create_mapping:function(a,n){return r.post(""+n+"/media_mapping/",a.mappings[e.lang]).success(function(t){return a.mappings[e.lang]=t}).error(function(){return t.addError(i("Failed to set timestamp"))}),!0}}}).service("uploadHelpers",function(){return{cavas_processor:function(e,t){var r;return null==t&&(t="image/jpeg"),console.log("called"),r=document.createElement("canvas"),r.width=e.width,r.height=e.height,r.getContext&&r.toBlob&&(r.getContext("2d").drawImage(e,0,0,e.width,e.height),r.toBlob(function(e){var t;return t=$("#drop_down, #museum_drop_down").filter(":visible").find("input[type=file]"),t.fileupload("add",{files:[e]})},t)),!0}}}).service("errorProcessing",function(e){return{errors:[],addError:function(t){var r;return r={error:t},this.errors.push(r),e.$broadcast("new_error",this.errors)},getErrors:function(){return this.errors},clearErrors:function(){return this.errors=[],e.$broadcast("new_error",this.errors)},deleteError:function(t){return this.errors.splice(t,1),e.$broadcast("new_error",this.errors)}}}).service("backendWrapper",function(e,t,r,i){return{museum_id:null!=r.$$path?r.$$path.split("/")[1]:"5285b3417de600691f000002",content_provider_id:"5285b3417de600691f000001",backend_url:"http://192.168.158.128:3000/api",museums:[],exhibits:[],modal_translations:[],langs:[],current_museum:{},active_exhibit:{},sort_field:"number",sort_direction:1,reload_exhibits:function(r,i,a){return null==r&&(r=r),null==i&&(i=i),e.get(""+backend_url+"/provider/"+content_provider_id+"/museums/"+museum_id+"/exhibits/"+r+"/"+i).success(function(e){var r,i,n,o,s,u,c,l,d,p,g,m,f,h,_,b,v,y;for(u=[],l=0,m=e.length;m>l;l++)if(s=e[l],null!=s){for(i=s.exhibit,i.images=[],i.mapped_images=[],i.cover={},b=s.images,d=0,f=b.length;f>d;d++)o=b[d],i.images.push(o),o.image.cover===!0&&(i.cover=o.image);for(i.stories={},v=s.stories,p=0,h=v.length;h>p;p++){for(c=v[p],c.story.quiz=c.quiz.quiz,c.story.audio=c.audio,c.story.video=c.video,c.story.quiz.answers=c.quiz.answers,c.story.mapped_images=[],y=i.images,g=0,_=y.length;_>g;g++)o=y[g],o.mappings[c.story.language]&&c.story.mapped_images.push(o);i.stories[c.story.language]=c.story}u.push(i)}return t.complete(),console.log("anim completed"),r=u[0],n=u,0===u.length&&($scope.active_exhibit={index:0,name:"Богоматерь Владимирская, с двунадесятыми праздниками",number:"1",image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",publish_state:"all",description:"",qr_code:{url:"/img/qr_code.png",print_link:"http://localhost:8000/img/qr_code.png"},images:[{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:1,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"},{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:2,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"}],stories:{ru:{name:"Богоматерь Владимирская, с двунадесятыми праздниками",description:"test description",publish_state:"all",audio:"http://www.jplayer.org/audio/ogg/TSP-01-Cro_magnon_man.ogg",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}}}}),null!=a?a.resolve():void 0})},fetch_data:function(r){return console.log(called),console.log(backendWrapper),t.start(),console.log("anim started"),e.get(""+backend_url+"/provider/"+content_provider_id+"/museums").success(function(e){var t,a,n,o,s,u,c,l,d,p,g,m,f,h,_,b,v,y,w,x,$,z,k,q,j;for(p=[],a=!1,u=[],c={},m=0,b=e.length;b>m;m++){for(o=e[m],l=o.exhibit,l.def_lang="ru",null==l.language&&(l.language="ru"),l.package_status="process",l.stories={},l.images=[],l.mapped_images=[],l.cover={},z=o.images,f=0,v=z.length;v>f;f++)n=z[f],l.images.push(n),n.image.cover===!0&&(l.cover=n.image);for(k=o.stories,h=0,y=k.length;y>h;h++){for(g=k[h],g.story.city="Saint-Petersburg",g.story.quiz=g.quiz.quiz,g.story.audio=g.audio,g.story.video=g.video,g.story.quiz.answers=g.quiz.answers,g.story.mapped_images=[],q=l.images,_=0,w=q.length;w>_;_++)n=q[_],n.mappings[g.story.language]&&g.story.mapped_images.push(n);l.stories[g.story.language]=g.story,u.push(g.story.language)}p.push(l),l.active=!1,l._id===d&&(l.active=!0,t=l,a=!0),u.unique()}for(a||(t=$scope.museums[0],t.def_lang="ru",null==l.language&&(t.language="ru"),d=t._id),j=$scope.langs,$=0,x=j.length;x>$;$++)s=j[$],c[s]={name:i(s)};return reload_exhibits(null,null,r)})}}})}).call(this);