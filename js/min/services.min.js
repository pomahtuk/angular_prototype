(function(){"use strict";angular.module("Museum.services",[]).service("sharedProperties",function(e){var r;return r={},{getProperty:function(e){return r[e]},setProperty:function(t,i){return r[t]=i,e.$broadcast("exhibitChange")}}}).service("storySetValidation",function(e,r){return{checkValidity:function(r){return null==r.item.images&&(r.item.images=[]),null==r.item.long_description&&(r.item.long_description=""),0!==r.item.long_description.length&&r.item.audio&&null!=r.root.number&&r.root.images.length>=1?(this.markValid(r),e.$broadcast("changes_to_save",r)):this.markInvalid(r)},markInvalid:function(t){return console.log("invalid"),"published"===t.item.status?(t.root.invalid=!0,r(function(){return t.item.status="passcode",null!=t.$digest&&t.$digest(),e.$broadcast("changes_to_save",t)},100)):e.$broadcast("changes_to_save",t)},markValid:function(e){return console.log("valid"),e.root.invalid=!1}}}).service("imageMappingHelpers",function(e,r,t,i){var s;return s=function(r){var t;return t=0,t+=r.image.order,null!=r.mappings[e.lang]&&(t-=100),t},{sort_weight_func:function(e,r){return s(e)>s(r)?1:s(e)<s(r)?-1:0},sort_time_func:function(r,t){if(null!=r.mappings[e.lang]&&null!=t.mappings[e.lang]&&r.mappings[e.lang].timestamp>=0){if(r.mappings[e.lang].timestamp>t.mappings[e.lang].timestamp)return 1;if(r.mappings[e.lang].timestamp<t.mappings[e.lang].timestamp)return-1}return 0},calc_timestamp:function(e,r){var t,i,s,n,o,a,u,l,m;return null==r&&(r=!1),l=$(".jp-seek-bar:visible"),o=$(".jp-duration:visible"),a=$(".jp-play:visible"),i=r?e.offset.left-l.offset().left:e.position.left-a.width(),t=l.width()-15,n=o.text(),m=parseInt(n.split(":")[1],10)+60*parseInt(n.split(":")[0],10),u=m/t,s=Math.round(i*u),0>=s&&(s=0),s},update_image:function(s,n){return t.put(""+n+"/media/"+s.image._id,s.image).success(function(){var o;return console.log("ok"),null!=s.mappings[e.lang]&&(o=s.mappings[e.lang],null!=o._id)?t.put(""+n+"/media_mapping/"+o._id,o).success(function(){return console.log("ok")}).error(function(){return r.addError(i("Failed to set timestamp"))}):void 0}).error(function(){return r.addError(i("Failed to set timestamp"))}),!0},update_images:function(e,s,n){return t.post(""+n+"/media_for/"+e+"/reorder",s).success(function(){return console.log("ok")}).error(function(){return r.addError(i("Failed to update order"))}),!0},create_mapping:function(s,n){return t.post(""+n+"/media_mapping/",s.mappings[e.lang]).success(function(r){return s.mappings[e.lang]=r}).error(function(){return r.addError(i("Failed to set timestamp"))}),!0}}}).service("uploadHelpers",function(){return{cavas_processor:function(e,r){var t;return null==r&&(r="image/jpeg"),console.log("called"),t=document.createElement("canvas"),t.width=e.width,t.height=e.height,t.getContext&&t.toBlob&&(t.getContext("2d").drawImage(e,0,0,e.width,e.height),t.toBlob(function(e){var r;return r=$("#drop_down, #museum_drop_down").filter(":visible").find("input[type=file]"),r.fileupload("add",{files:[e]})},r)),!0}}}).service("errorProcessing",function(e){return{errors:[],addError:function(r){var t;return t={error:r},this.errors.push(t),e.$broadcast("new_error",this.errors)},getErrors:function(){return this.errors},clearErrors:function(){return this.errors=[],e.$broadcast("new_error",this.errors)},deleteError:function(r){return this.errors.splice(r,1),e.$broadcast("new_error",this.errors)}}}).service("backendWrapper",function(e,r,t,i){return{museum_id:"5285b3417de600691f000002",content_provider_id:"5285b3417de600691f000001",backend_url:"http://192.168.158.128:3000/api",museums:[],exhibits:[],modal_translations:[],langs:[],current_museum:{},active_exhibit:{},sort_field:"number",sort_direction:1,ajax_progress:!0,grouped_positions:{},reload_exhibits:function(t,i,s){var n;return null==t&&(t=t),null==i&&(i=i),n=e.get(""+this.backend_url+"/provider/"+this.content_provider_id+"/museums/"+this.museum_id+"/exhibits/"+this.sort_field+"/"+this.sort_direction),n.success(function(e){var t,i,n,o,a,u,l,m,c,d,g,p,h,f,_,v;for(o=[],u=0,d=e.length;d>u;u++)if(n=e[u],null!=n){for(t=n.exhibit,t.images=[],t.mapped_images=[],t.cover={},f=n.images,l=0,g=f.length;g>l;l++)i=f[l],t.images.push(i),i.image.cover===!0&&(t.cover=i.image);for(t.stories={},_=n.stories,m=0,p=_.length;p>m;m++){for(a=_[m],a.story.quiz=a.quiz.quiz,a.story.audio=a.audio,a.story.video=a.video,a.story.quiz.answers=a.quiz.answers,a.story.mapped_images=[],v=t.images,c=0,h=v.length;h>c;c++)i=v[c],i.mappings[a.story.language]&&a.story.mapped_images.push(i);t.stories[a.story.language]=a.story}o.push(t)}return r.complete(),console.log("anim completed"),this.active_exhibit=o[0],this.exhibits=o,this.ajax_progress=!1,null!=s?s.resolve():void 0}.bind(this)),n.error(function(){return r.complete(),null!=s?s.reject():void 0})},fetch_data:function(t,s){var n;return r.color("#fd6e3b"),r.start(),console.log("anim started"),null!=t&&(this.museum_id=t),n=e.get(""+this.backend_url+"/provider/"+this.content_provider_id+"/museums"),n.success(function(e){var r,n,o,a,u,l,m,c,d,g,p,h,f,_,v,b,y,w,x,k,$;for(this.museums=[],n=!1,this.langs=[],this.modal_translations={},c=0,h=e.length;h>c;c++){for(a=e[c],l=a.exhibit,l.def_lang="ru",null==l.language&&(l.language="ru"),l.package_status="process",l.stories={},l.images=[],l.mapped_images=[],l.cover={},w=a.images,d=0,f=w.length;f>d;d++)o=w[d],l.images.push(o),o.image.cover===!0&&(l.cover=o.image);for(x=a.stories,g=0,_=x.length;_>g;g++){for(m=x[g],m.story.city="Saint-Petersburg",m.story.quiz=m.quiz.quiz,m.story.audio=m.audio,m.story.video=m.video,m.story.quiz.answers=m.quiz.answers,m.story.mapped_images=[],k=l.images,p=0,v=k.length;v>p;p++)o=k[p],o.mappings[m.story.language]&&m.story.mapped_images.push(o);l.stories[m.story.language]=m.story,this.langs.push(m.story.language)}this.museums.push(l),l.active=!1,l._id===t&&(l.active=!0,r=l,n=!0),this.langs.unique()}for(n||(this.current_museum=this.museums[0],this.current_museum.def_lang="ru",null==l.language&&(this.current_museum.language="ru"),this.museum_id=this.current_museum._id),$=this.langs,y=0,b=$.length;b>y;y++)u=$[y],this.modal_translations[u]={name:i(u)};return this.reload_exhibits(null,null,s)}.bind(this)),n.error(function(){return r.complete(),null!=s?s.reject():void 0})}}})}).call(this);