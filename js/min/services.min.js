(function(){"use strict";angular.module("Museum.services",[]).service("sharedProperties",function(r){var e;return e={},{getProperty:function(r){return e[r]},setProperty:function(t,n){return e[t]=n,r.$broadcast("exhibitChange")}}}).service("storySetValidation",function(r,e){return{checkValidity:function(e){return null==e.item.images&&(e.item.images=[]),null==e.item.long_description&&(e.item.long_description=""),0!==e.item.long_description.length&&e.item.audio&&null!=e.root.number&&e.root.images.length>=1?(this.markValid(e),r.$broadcast("changes_to_save",e)):this.markInvalid(e)},markInvalid:function(t){return console.log("invalid"),"published"===t.item.status?(t.root.invalid=!0,e(function(){return t.item.status="passcode",null!=t.$digest&&t.$digest(),r.$broadcast("changes_to_save",t)},100)):r.$broadcast("changes_to_save",t)},markValid:function(r){return console.log("valid"),r.root.invalid=!1}}}).service("imageMappingHelpers",function(r,e,t,n){var i;return i=function(e){var t;return t=0,t+=e.image.order,null!=e.mappings[r.lang]&&(t-=100),t},{sort_weight_func:function(r,e){return i(r)>i(e)?1:i(r)<i(e)?-1:0},sort_time_func:function(e,t){if(null!=e.mappings[r.lang]&&null!=t.mappings[r.lang]&&e.mappings[r.lang].timestamp>=0){if(e.mappings[r.lang].timestamp>t.mappings[r.lang].timestamp)return 1;if(e.mappings[r.lang].timestamp<t.mappings[r.lang].timestamp)return-1}return 0},calc_timestamp:function(r,e){var t,n,i,o,a,s,u,l,c;return null==e&&(e=!1),l=$(".jp-seek-bar:visible"),a=$(".jp-duration:visible"),s=$(".jp-play:visible"),n=e?r.offset.left-l.offset().left:r.position.left-s.width(),t=l.width()-15,o=a.text(),c=parseInt(o.split(":")[1],10)+60*parseInt(o.split(":")[0],10),u=c/t,i=Math.round(n*u),0>=i&&(i=0),i},update_image:function(i,o){return t.put(""+o+"/media/"+i.image._id,i.image).success(function(){var a;return console.log("ok"),null!=i.mappings[r.lang]&&(a=i.mappings[r.lang],null!=a._id)?t.put(""+o+"/media_mapping/"+a._id,a).success(function(){return console.log("ok")}).error(function(){return e.addError(n("Failed to set timestamp"))}):void 0}).error(function(){return e.addError(n("Failed to set timestamp"))}),!0},update_images:function(r,i,o){return t.post(""+o+"/media_for/"+r+"/reorder",i).success(function(){return console.log("ok")}).error(function(){return e.addError(n("Failed to update order"))}),!0},create_mapping:function(i,o){return t.post(""+o+"/media_mapping/",i.mappings[r.lang]).success(function(e){return i.mappings[r.lang]=e}).error(function(){return e.addError(n("Failed to set timestamp"))}),!0}}}).service("uploadHelpers",function(){return{cavas_processor:function(r,e){var t;return null==e&&(e="image/jpeg"),console.log("called"),t=document.createElement("canvas"),t.width=r.width,t.height=r.height,t.getContext&&t.toBlob&&(t.getContext("2d").drawImage(r,0,0,r.width,r.height),t.toBlob(function(r){var e;return e=$("#drop_down, #museum_drop_down").filter(":visible").find("input[type=file]"),e.fileupload("add",{files:[r]})},e)),!0}}}).service("errorProcessing",function(r){return{errors:[],addError:function(e){var t;return t={error:e},this.errors.push(t),r.$broadcast("new_error",this.errors)},getErrors:function(){return this.errors},clearErrors:function(){return this.errors=[],r.$broadcast("new_error",this.errors)},deleteError:function(e){return this.errors.splice(e,1),r.$broadcast("new_error",this.errors)}}})}).call(this);