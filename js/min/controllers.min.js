(function(){"use strict";var e,t,r;$.fn.refresh=function(){return $(this.selector)},$.fn.isEmpty=function(){return 0===this.length},t=function(e){var t,r;return e=$(e),r=e.offset().top,t=function(){return r<$(this).offset().top},$.merge(e,e.nextUntil(t)).last()},e=function(e,t){return e.length>0&&t.length>0&&e.offset().top===t.offset().top},r=function(e,t,r,i){var n,s,a,u,o,c;return c=$(window).innerWidth(),u=t+r,o=c-2*i+r,s=Math.floor(o/u),n=c-(s*u-r),a=Math.floor(n/2),e.css({"margin-right":0,"margin-left":r}),e.each(function(e){return 0===e%s?$(this).css({"margin-left":a}):void 0})},this.gon={google_api_key:"AIzaSyCPyGutBfuX48M72FKpF4X_CxxPadq6r4w",acceptable_extensions:{audio:["mp3","ogg","aac","wav","amr","3ga","m4a","wma","mp4","mp2","flac"],image:["jpg","jpeg","gif","png","tiff","bmp"],video:["mp4","m4v","avi","ogv"]},development:!1},angular.module("Museum.controllers",[]).controller("IndexController",["$scope","$http","$filter","$window","$modal","$routeParams","$location","ngProgress","storySetValidation","errorProcessing",function(i,n,s,a,u,o,c,l,d,m){var _,g,p,f,h,b,w,v;return window.sc=i,console.log(o,c),i.exhibit_search="",i.criteriaMatch=function(e){return function(t){var r;return null!=t.stories[i.current_museum.language]?t.stories[i.current_museum.language].name?(r=t.stories[i.current_museum.language].name.toLowerCase().indexOf(e.toLowerCase())>-1,i.grid(),r||""===e):!0:!0}},i.museum_change_progress=!0,l.color("#fd6e3b"),v=null!=c.$$path?c.$$path.split("/")[1]:"5260c63ceb6688e516000002",_=null!=o.content_provider_id?o.content_provider_id:"5260c63ceb6688e516000001",i.backend_url="http://192.168.158.128:3000/api",i.sort_field="number",i.sort_direction=1,i.sort_text="Sort 0-9",i.ajax_progress=!0,i.story_subtab="video",i.museum_subtab="video",i.reload_exhibits=function(e,t){return null==e&&(e=i.sort_field),null==t&&(t=i.sort_direction),n.get(""+i.backend_url+"/provider/"+_+"/museums/"+v+"/exhibits/"+e+"/"+t).success(function(e){var t,r,n,s,a,u,o,c,d;for(r=[],i.modal_translations={},a=0,o=e.length;o>a;a++)if(n=e[a],null!=n){for(t=n.exhibit,t.images=n.images,t.stories={},d=n.stories,u=0,c=d.length;c>u;u++)s=d[u],s.story.quiz=s.quiz.quiz,s.story.audio=s.audio,s.story.video=s.video,s.story.quiz.answers=s.quiz.answers,t.stories[s.story.language]=s.story,i.modal_translations[s.story.language]={name:i.translations[s.story.language]};r.push(t)}return l.complete(),console.log("anim completed"),i.active_exhibit=r[0],i.exhibits=r,i.ajax_progress=!1,0===r.length&&(i.active_exhibit={index:0,name:"Богоматерь Владимирская, с двунадесятыми праздниками",number:"1",image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",publish_state:"all",description:"",qr_code:{url:"/img/qr_code.png",print_link:"http://localhost:8000/img/qr_code.png"},images:[{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:1,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"},{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:2,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"}],stories:{ru:{name:"Богоматерь Владимирская, с двунадесятыми праздниками",description:"test description",publish_state:"all",audio:"http://www.jplayer.org/audio/ogg/TSP-01-Cro_magnon_man.ogg",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}}}}),i.museum_change_progress=!1})},i.reload_museums=function(){return l.start(),console.log("anim started"),n.get(""+i.backend_url+"/provider/"+_+"/museums").success(function(e){var t,r,n,s,a,u,o,c,l;for(i.museums=[],t=!1,a=0,o=e.length;o>a;a++){for(r=e[a],n=r.exhibit,n.def_lang="ru",n.language||(n.language="ru"),n.package_status="process",n.stories={},n.images=r.images,l=r.stories,u=0,c=l.length;c>u;u++)s=l[u],s.story.city="Saint-Petersburg",s.story.quiz=s.quiz.quiz,s.story.audio=s.audio,s.story.video=s.video,s.story.quiz.answers=s.quiz.answers,n.stories[s.story.language]=s.story;i.museums.push(n),n.active=!1,n._id===v&&(n.active=!0,i.current_museum=n,t=!0)}return t||(i.current_museum=i.museums[0],i.current_museum.def_lang="ru",i.current_museum.language="ru",v=i.current_museum._id),i.reload_exhibits()})},i.reload_museum=function(){return n.get(""+i.backend_url+"/provider/"+_+"/museums/"+v).success(function(e){var t,r,n,s,a;for(t=e.exhibit,t.def_lang="ru",t.language="ru",t.stories={},a=e.stories,n=0,s=a.length;s>n;n++)r=a[n],r.story.quiz=r.quiz.quiz,r.story.quiz.answers=r.quiz.answers,r.story.images=r.images,r.story.audio=r.audio,t.stories[r.story.language]=r.story;return i.current_museum=t})},i.reload_museums(),i.museums=[{name:"Imperial Peace Museum",packege_status:"generated",city:"London",image:"/img/museum.jpg",type:"museum"},{name:"Imperial War Museum",packege_status:"generated",city:"Tokio",image:"/img/museum.jpg",type:"museum"},{name:"Imperial Peace Exhibitin",packege_status:"generated",city:"Moscow",image:"/img/museum.jpg",type:"museum"},{name:"Imperial War Exhibitin",packege_status:"generated",city:"Berlin",image:"/img/museum.jpg",type:"museum"},{name:"Republican Peace Museum",packege_status:"process",city:"Tokio",image:"/img/museum.jpg",type:"tour"},{name:"Republican Peace Exhibitin",packege_status:"process",city:"London",image:"/img/museum.jpg",type:"tour"},{name:"Republican War Museum",packege_status:"process",city:"Berlin",image:"/img/museum.jpg",type:"tour"},{name:"Republican War Exhibitin",packege_status:"process",city:"London",image:"/img/museum.jpg",type:"museum"}],i.user={mail:"pman89@yandex.ru",providers:[{name:"IZI.travel Test Provider"},{name:"IZI.travel Second Provider"}]},i.provider={name:"content_1",id:"1",passcode:"passcode",passcode_edit_link:"/1/pass/edit/"},i.translations={ru:"Russian",en:"English",es:"Spanish",ge:"German",fi:"Finnish",sw:"Sweedish",it:"Italian",fr:"French",kg:"Klingon"},i.modal_translations={ru:{name:"Russian"},en:{name:"English"},es:{name:"Spanish"},ge:{name:"German"},fi:{name:"Finnish"},sw:{name:"Sweedish"},it:{name:"Italian"},fr:{name:"French"},kg:{name:"Klingon"}},i.exhibits=[{index:0,name:"Богоматерь Владимирская, с двунадесятыми праздниками",number:"1",image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",publish_state:"all",description:"",qr_code:{url:"/img/qr_code.png",print_link:"http://localhost:8000/img/qr_code.png"},images:[{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:1,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"},{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:2,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"}],stories:{ru:{name:"Богоматерь Владимирская, с двунадесятыми праздниками",description:"test description",publish_state:"all",audio:"http://www.jplayer.org/audio/ogg/TSP-01-Cro_magnon_man.ogg",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}},en:{name:"Богоматерь Владимирская, с двунадесятыми праздниками",description:"test description",publish_state:"all",audio:"http://www.jplayer.org/audio/ogg/TSP-01-Cro_magnon_man.ogg",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}},es:{name:"Богоматерь Владимирская, с двунадесятыми праздниками",description:"test description",publish_state:"all",audio:"http://www.jplayer.org/audio/ogg/TSP-01-Cro_magnon_man.ogg",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}}}}],i.active_exhibit=i.exhibits[0],i.current_museum={language:"ru",def_lang:"ru",name:"Museum of modern art",index:2,number:3,image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",publish_state:"all",description:"",qr_code:{url:"/img/qr_code.png",print_link:"http://localhost:8000/img/qr_code.png"},images:[{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:1,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"},{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:2,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"}],stories:{en:{name:"English",language:"en",publish_state:"all",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}},es:{name:"Spanish",language:"es",publish_state:"all",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}},ru:{name:"Russian",language:"ru",publish_state:"all",audio:"http://www.jplayer.org/audio/ogg/TSP-01-Cro_magnon_man.ogg",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}}},new_story_link:"/1/1/1/"},i.element_switch=!0,i.forbid_switch=!1,i.create_new_language=!1,g=$("#drop_down").removeClass("hidden").hide(),p=function(){return $("ul.exhibits li.exhibit.active")},i.dummy_focusout_process=function(){var e,t,r,n,s;if(""===g.find("#name").val()){for(t=!0,s=g.find("#media .form-control:not(#opas_number)"),r=0,n=s.length;n>r;r++)e=s[r],e=$(e),""!==e.val()&&(t=!1);return t?i.new_item_creation=!1:i.dummy_modal_open()}},i.closeDropDown=function(){var e;return console.log("closing"),e=p(),e.hasClass("dummy")&&i.dummy_focusout_process(e),g.hide(),e.removeClass("active")},i.attachDropDown=function(e){var r;return e=$(e),r=g.hasClass("inited"),g.show().insertAfter(t(e)),r?void 0:(g.addClass("inited"),g.find("a.done, .close").unbind("click").bind("click",function(e){return e.preventDefault(),i.closeDropDown()}),g.find(">.prev-ex").unbind("click").bind("click",function(e){var t,r;return e.preventDefault(),t=p(),r=t.prev(".exhibit"),("drop_down"===r.attr("id")||r.hasClass("dummy"))&&(r=r.prev()),r.length>0?r.find(".opener .description").click():t.siblings(".exhibit").last().find(".opener").click()}),g.find(">.next-ex").unbind("click").bind("click",function(e){var t,r;return e.preventDefault(),t=p(),r=t.next(),("drop_down"===r.attr("id")||r.hasClass("dummy"))&&(r=r.next()),r.length>0?r.find(".opener .description").click():t.siblings(".exhibit").first().find(".opener").click()}),g.find("a.delete_story").unbind("click").bind("click",function(e){var t;return t=$(this),t.hasClass("no_margin")?(e.preventDefault(),e.stopPropagation(),i.closeDropDown()):void 0}))},i.open_dropdown=function(t,r){var n,s,a,u,o,c,l,d,m;if(n=$(t.target).parents("li"),i.forbid_switch===!0)return t.stopPropagation(),!1;if(n.hasClass("active"))return i.closeDropDown(),!1;for(i.new_item_creation&&p().length>0&&i.closeDropDown(),m=i.exhibits,l=0,d=m.length;d>l;l++)a=m[l],null!=a&&(a.active=!1);return r.active=!0,i.element_switch=!0,setTimeout(function(){return i.element_switch=!1},200),i.active_exhibit=r,c=p(),c.hasClass("dummy")&&i.dummy_focusout_process(c),c.removeClass("active"),n.addClass("active"),e(n,c)||(i.attachDropDown(n),setTimeout(function(){return $.scrollTo(n,500)},100)),u=g.find(".item_publish_settings"),s=g.find(".delete_story"),n.hasClass("dummy")?(o=n.data("number"),$("#opas_number").val(o).blur(),$("#name").focus(),u.hide(),s.addClass("no_margin")):(u.show(),s.removeClass("no_margin"))},i.museum_type_filter="",i.grid=function(){var e,t,i,n;return e=$(".exhibits>li.exhibit"),t=60,n=e.first().width(),i=40,r(e,n,i,t)},i.museum_list_prepare=function(){var e,t,r,i;return t=$("ul.museum_list"),e=t.find("li").length,i=$("body").width(),r=(150*e+160)/i,r>1?($(".museum_filters").show(),t.width(i-200)):($(".museum_filters").hide(),t.width(i-100))},setTimeout(function(){return i.museum_list_prepare()},200),$(window).resize(function(){return setTimeout(function(){return i.museum_list_prepare()},100)}),i.new_item_creation=!1,i.all_selected=!1,i.modal_options={current_language:{name:i.translations[i.current_museum.language],language:i.current_museum.language},languages:i.modal_translations,exhibits:i.exhibits,deletion_password:"123456"},b=function(){var e;return e=0,e=i.exhibits[i.exhibits.length-1]?parseInt(i.exhibits[i.exhibits.length-1].number,10)+1:1},f=function(){return i.current_museum.language},w=function(e){return e===i.current_museum.language?"passcode":"dummy"},h=function(e){return e===i.current_museum.language?"Экспонат_"+e:""},i.create_dummy_story=function(e){var t,r,i;for(t={playback_algorithm:"generic",content_provider:_,story_type:"story",status:"draft",language:"dummy",name:"",short_description:"",long_description:"",story_set:e},t.quiz={story:"",question:"",comment:"",status:"passcode",answers:[]},r=i=0;3>=i;r=++i)t.quiz.answers.push({quiz:"",content:"",correct:!1});return t.quiz.answers[0].correct=!0,t},i.new_museum_language=function(){var e,t;return i.create_new_language=!0,t=i.create_dummy_story(i.current_museum._id),t.quiz.answers[0].correct=!0,i.dummy_museum=angular.copy(i.current_museum),i.dummy_museum.stories.dummy=t,i.dummy_museum.stories.dummy.status="passcode",i.dummy_museum.language="dummy",i.modal_options={museum:i.dummy_museum,translations:i.translations},e=u.open({templateUrl:"myMuseumModalContent.html",controller:ModalMuseumInstanceCtrl,resolve:{modal_options:function(){return i.modal_options}}}),e.result.then(function(e){var t,r,n,s,a,u;switch(e){case"save":for(console.log(i.dummy_museum),r=i.dummy_museum.language,i.dummy_museum.stories[r]=i.dummy_museum.stories.dummy,i.dummy_museum.stories[r].language=r,u=i.exhibits,s=0,a=u.length;a>s;s++)t=u[s],t.stories[r]=i.dummy_museum.stories[r],t.stories[r].language=r,t.stories[r].name="",t.stories[r].status="draft",t.stories[r].story_set=t._id,n=angular.copy(t.stories[r]),i.post_stories(n);return i.current_museum.stories[r]=i.dummy_museum.stories[r],i.current_museum.language=r,n=angular.copy(i.dummy_museum.stories[r]),n.story_set=i.current_museum._id,i.post_stories(n),i.create_new_language=!1;case"discard":return!0}},function(){return console.log("Modal dismissed at: "+new Date)}),!0},i.create_new_item=function(){var e,t,r,n,s;if(i.new_item_creation!==!0){n=b(),i.new_exhibit={content_provider:_,number:n,type:"exhibit",distance:20,duration:20,status:"draft",route:"",category:"",parent:v,name:"",qr_code:{url:"",print_link:""},stories:{}},i.new_exhibit.images=[];for(r in i.current_museum.stories){for(i.new_exhibit.stories[r]={playback_algorithm:"generic",content_provider:_,story_type:"story",status:"draft",language:r,name:"",short_description:"",long_description:"",story_set:""},i.new_exhibit.stories[r].quiz={story:"",question:"",comment:"",status:"passcode",answers:[]},t=s=0;3>=s;t=++s)i.new_exhibit.stories[r].quiz.answers.push({quiz:"",content:"",correct:!1});i.new_exhibit.stories[r].quiz.answers[0].correct=!0}return i.new_item_creation=!0,e={},e.target=$("li.exhibit.dummy > .opener.draft"),i.open_dropdown(e,i.new_exhibit),i.grid()}},i.check_selected=function(){var e,t,r,n,s;for(e=0,i.select_all_enabled=!1,s=i.exhibits,r=0,n=s.length;n>r;r++)t=s[r],t.selected===!0&&(i.select_all_enabled=!0,e+=1);return e===i.exhibits.length?i.all_selected=!0:void 0},i.select_all_exhibits=function(e){var t,r,n,s,a;if(null!=e)switch(e){case"select":r=!0;break;case"cancel":r=!1}else r=!i.all_selected;for(a=i.exhibits,n=0,s=a.length;s>n;n++)t=a[n],t.selected=r;return i.all_selected=!i.all_selected,i.select_all_enabled=r},i.delete_modal_open=function(){var e;return i.new_item_creation?!0:(e=u.open({templateUrl:"myModalContent.html",controller:ModalDeleteInstanceCtrl,resolve:{modal_options:function(){return i.modal_options}}}),e.result.then(function(e){return i.delete_exhibit(i.active_exhibit,e.selected)},function(){return console.log("Modal dismissed at: "+new Date)}))},i.delete_museum_modal_open=function(){var e;return i.new_item_creation?!0:(e=u.open({templateUrl:"museumDelete.html",controller:museumDeleteCtrl,resolve:{modal_options:function(){return i.modal_options}}}),e.result.then(function(e){var t,r,n,s,a,u,o,c,l;if(r=i.current_museum.language,"lang"===e){for(i.current_museum.language=i.current_museum.def_lang,c=i.exhibits,s=0,u=c.length;u>s;s++)t=c[s],i.delete_story(t.stories,r,function(e,t){return delete e[t],!0});return i.delete_story(i.current_museum.stories,r,function(e,t){return delete e[t],!0})}for(console.log("deleting museum story or whole museum"),n=i.current_museum,l=i.exhibits,a=0,o=l.length;o>a;a++)t=l[a],i.delete_story_set(t);return i.delete_story_set(n)},function(){return console.log("Modal dismissed at: "+new Date)}))},i.delete_exhibit=function(e,t){var r,n,s,a,u,o,c,l,d,m,_;if(t.length>=Object.keys(e.stories).length){for(i.closeDropDown(),l=i.exhibits,m=[],n=o=0,c=l.length;c>o;n=++o){if(r=l[n],r._id===e._id){i.exhibits.splice(n,1),i.grid(),e._id===i.active_exhibit._id&&(i.active_exhibit=i.exhibits[0]),i.delete_story_set(e);break}m.push(void 0)}return m}console.log(e._id),d=e.stories,_=[];for(a in d)u=d[a],_.push(function(){var r,n,o;for(o=[],r=0,n=t.length;n>r;r++)s=t[r],s===a?(e.selected=!1,u=e.stories[a],u.status="dummy",u.name="",u.short_description="",u.long_description="",u.quiz.question="",u.quiz.comment="",u.quiz.status="",u.quiz.answers||(u.quiz.answers=[]),u.quiz.answers[0].content="",u.quiz.answers[0].correct=!0,u.quiz.answers[1].content="",u.quiz.answers[1].correct=!1,u.quiz.answers[2].content="",u.quiz.answers[2].correct=!1,u.quiz.answers[3].content="",u.quiz.answers[3].correct=!1,o.push(i.update_story(u))):o.push(void 0);return o}());return _},i.dummy_modal_open=function(){var e;return e=u.open({templateUrl:"myDummyModalContent.html",controller:ModalDummyInstanceCtrl,resolve:{modal_options:function(){return{exhibit:i.active_exhibit}}}}),e.result.then(function(e){return i.new_item_creation=!1,i.item_deletion=!0,"save_as"===e?(i.new_exhibit.stories[i.current_museum.language].name="item_"+i.new_exhibit.number,i.new_exhibit.stories[i.current_museum.language].publish_state="passcode",i.new_exhibit.active=!1,i.exhibits.push(i.new_exhibit)):(i.closeDropDown(),i.new_exhibit.active=!1,i.active_exhibit=i.exhibits[0]),i.item_deletion=!1},function(){return console.log("Modal dismissed at: "+new Date)})},i.show_museum_edit=function(e){var t,r;return t=$(e.target),r||(r=!0,t.find("i").toggleClass("icon-chevron-down icon-chevron-up"),$(".navigation .museum_edit").slideToggle(1e3,"easeOutQuint"),i.museum_edit_dropdown_opened=!i.museum_edit_dropdown_opened),!1},i.museum_edit_dropdown_close=function(){var e;return e={target:$(".museum_edit_opener")},i.museum_edit_dropdown_opened?i.show_museum_edit(e):void 0},i.update_story=function(e){return n.put(""+i.backend_url+"/story/"+e._id,e).success(function(){return n.put(""+i.backend_url+"/quiz/"+e.quiz._id,e.quiz).success(function(){var t,r,n,s,a;for(s=e.quiz.answers,a=[],r=0,n=s.length;n>r;r++)t=s[r],a.push(i.put_answers(t));return a}).error(function(){return m.addError("Failed to update a quiz for story")})}).error(function(){return m.addError("Failed update a story")})},i.put_answers=function(e){return n.put(""+i.backend_url+"/quiz_answer/"+e._id,e).success(function(){return console.log("done")}).error(function(){return m.addError("Failed to save quiz answer")})},i.post_stories=function(e){var t;return t=e,n.post(""+i.backend_url+"/story/",t).success(function(e){return t._id=e._id,t.quiz.story=e._id,n.post(""+i.backend_url+"/quiz/",t.quiz).success(function(e){var r,n,s,a,u;for(t.quiz._id=e.id,a=t.quiz.answers,u=[],n=0,s=a.length;s>n;n++)r=a[n],r.quiz=e._id,u.push(i.post_answers(r));return u}).error(function(){return m.addError("Failed to save quiz for new story")})}).error(function(){return m.addError("Failed to save new story")})},i.post_answers=function(e){return n.post(""+i.backend_url+"/quiz_answer/",e).success(function(t){return e._id=t._id}).error(function(){return m.addError("Failed to save quiz answer")})},i.mass_switch_pub=function(e){var t,r,n,s,a,u;for(a=i.exhibits,u=[],n=0,s=a.length;s>n;n++)if(t=a[n],t.selected===!0&&"dummy"!==t.stories[i.current_museum.language].status){switch(r={},r.item=t.stories[i.current_museum.language],r.root=t,r.field_type="story",e){case"passcode":r.item.status="passcode";break;case"published":r.item.status="published"}u.push(d.checkValidity(r))}else u.push(void 0);return u},i.delete_selected_exhibits=function(){var e;return i.modal_options={current_language:{name:i.translations[i.current_museum.language],language:i.current_museum.language},languages:i.modal_translations,exhibits:i.exhibits,deletion_password:"123456"},e=u.open({templateUrl:"myModalContent.html",controller:ModalDeleteInstanceCtrl,resolve:{modal_options:function(){return i.modal_options}}}),e.result.then(function(e){var t,r,n,s,a;for(console.log(e.ids_to_delete),s=e.ids_to_delete,a=[],r=0,n=s.length;n>r;r++)t=s[r],t.selected===!0?(t.selected=!1,a.push(i.delete_exhibit(t,e.selected))):a.push(void 0);return a},function(){return console.log("Modal dismissed at: "+new Date)})},i.delete_story=function(e,t,r){return n["delete"](""+i.backend_url+"/story/"+e[t]._id).success(function(i){return console.log(i),null!=r?r(e,t):void 0}).error(function(){return m.addError("Failed to delete story in languane: "+i.translations[t])})},i.delete_story_set=function(e){return n["delete"](""+i.backend_url+"/story_set/"+e._id+"/").success(function(e){return console.log(e)}).error(function(){return m.addError("Failed to delete exhibit with number"+e.number)})},i.$watch("current_museum.language",function(e){return e&&"dummy"!==e&&i.current_museum._id?(i.modal_options.current_language={name:i.translations[i.current_museum.language],language:i.current_museum.language},i.create_new_language=!1,n.put(""+i.backend_url+"/story_set/"+i.current_museum._id,i.current_museum).success(function(e){return console.log(e),i.last_save_time=new Date}).error(function(){return m.addError("Failed to save museum language")})):void 0}),i.$on("save_new_exhibit",function(){return console.log("saving!"),i.new_exhibit.stories[i.current_museum.language].status="passcode",n.post(""+i.backend_url+"/story_set/",i.new_exhibit).success(function(e){var t,r,n;i.exhibits.push(i.new_exhibit),i.new_exhibit._id=e._id,i.last_save_time=new Date,n=i.new_exhibit.stories;for(t in n)r=n[t],r.publish_state="passcode",r.story_set=e._id,i.post_stories(r);return g.find(".item_publish_settings").show()}).error(function(){return m.addError("Failed to save new exhibit")}),i.new_item_creation=!1,i.$digest()}),i.$on("changes_to_save",function(e,t){return n.put(""+i.backend_url+"/"+t.field_type+"/"+t.item._id,t.item).success(function(e){return t.satus="done",i.last_save_time=new Date,console.log(e)}).error(function(){return m.addError("Server error - Prototype error.")}),i.forbid_switch=!1}),i.$on("quiz_changes_to_save",function(e,t,r){var s,a,u,o,c;for(c=t.collection,u=0,o=c.length;o>u;u++)a=c[u],s=a._id===r._id?!0:!1,a.correct=s,a.correct_saved=s,n.put(""+i.backend_url+"/"+t.field_type+"/"+a._id,a).success(function(e){return console.log(e),i.last_save_time=new Date}).error(function(){return m.addError("Failed to update quiz")});return i.forbid_switch=!1}),i.$watch(function(){return c.path()},function(e,t){var r,n,s,a;if(null!=e&&e!==t){for(l.complete(),l.start(),console.log("anim started"),i.museum_change_progress=!0,v=e.split("/")[1],a=i.museums,n=0,s=a.length;s>n;n++)r=a[n],r._id===v?(r.active=!0,i.current_museum=r):r.active=!1;return i.reload_exhibits()}}),i.$watch("museum_change_progress",function(e){return null!=e?e?($(".page-wrapper .page").fadeOut(300),$(".page-preloader").fadeIn(300)):($(".page-wrapper .page").fadeIn(300),$(".page-preloader").fadeOut(300)):void 0})}]).controller("MuseumEditController",["$scope","$http","$filter","$window","$modal","storage",function(e){return setTimeout(function(){return e.$parent.museumQuizform=e.museumQuizform,e=e.$parent},100),e.$watch("current_museum.stories[current_museum.language].quiz",function(t){if("limited"===t.state){if(!$("#museum_story_quiz_disabled").is(":checked"))return setTimeout(function(){return $("#museum_story_quiz_disabled").click()},10)}else if("published"===t.state)return $("#museum_story_quiz_enabled").is(":checked")?setTimeout(function(){return e.museumQuizform.$valid?void 0:setTimeout(function(){return $("#museum_story_quiz_disabled").click()},10)},100):setTimeout(function(){return $("#museum_story_quiz_enabled").click()},10)},!0),e.$watch("current_museum.stories[current_museum.language].quiz.question",function(){return null!=e.museumQuizform?e.museumQuizform.$valid?e.mark_quiz_validity(e.museumQuizform.$valid):setTimeout(function(){return $("#museum_story_quiz_disabled").click(),e.mark_quiz_validity(e.museumQuizform.$valid)},10):void 0}),e.$watch(function(){return angular.toJson(e.current_museum.stories[e.current_museum.language].quiz.answers)},function(){return null!=e.museumQuizform?e.museumQuizform.$valid?e.mark_quiz_validity(e.museumQuizform.$valid):setTimeout(function(){return $("#museum_story_quiz_disabled").click()},10):void 0},!0),!0}]),this.ModalDeleteInstanceCtrl=function(e,t,r){return e.modal_options=r,e.deletion_password="",e.only_one=1===e.modal_options.languages.length,e.password_input_shown=!1,e.ok=function(){var i,n,s,a,u,o,c,l;e.selected=[],e.ids_to_delete=[],c=e.modal_options.languages;for(n in c)a=c[n],a.checked===!0&&e.selected.push(n);for(l=r.exhibits,u=0,o=l.length;o>u;u++)i=l[u],i.selected===!0&&e.ids_to_delete.push(i);return s={ids_to_delete:e.ids_to_delete,selected:e.selected},e.ids_to_delete.length<=1?t.close(s):(e.password_input_shown=!0,e.deletion_password===r.deletion_password?t.close(s):void 0)},e.cancel=function(){return t.dismiss()},e.mark_all=function(){var t,r,i,n;i=e.modal_options.languages,n=[];for(t in i)r=i[t],n.push(r.checked=!0);return n},e.mark_default_only=function(){var t,r,i,n;i=e.modal_options.languages,n=[];for(t in i)r=i[t],r.checked=!1,e.modal_options.current_language.language===t?n.push(r.checked=!0):n.push(void 0);return n},e.mark_default_only()},this.museumDeleteCtrl=function(e,t,r){return e.modal_options=r,e.deletion_password="",e.variant={checked:"lang"},e.ok=function(){return e.deletion_password===r.deletion_password?t.close(e.variant.checked):void 0},e.cancel=function(){return t.dismiss()}},this.ModalDummyInstanceCtrl=function(e,t,r){return e.exhibit=r.exhibit,e.discard=function(){return t.close("discard")},e.save_as=function(){return t.close("save_as")}},this.ModalMuseumInstanceCtrl=function(e,t,r){return e.museum=r.museum,e.translations=r.translations,e.discard=function(){return t.close("discard")},e.save_as=function(){return t.close("save",e.museum)}}}).call(this);