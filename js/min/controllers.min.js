(function(){"use strict";var e,t,i;Array.prototype.unique=function(){var e,t,i,r;for(e=[],r=this.length,t=0;r>t;){for(i=t+1;r>i;)this[t]===this[i]&&(i=++t),i++;e.push(this[t]),t++}return e},$.fn.refresh=function(){return $(this.selector)},$.fn.isEmpty=function(){return 0===this.length},t=function(e){var t,i;return e=$(e),i=e.offset().top,t=function(){return i<$(this).offset().top},$.merge(e,e.nextUntil(t)).last()},e=function(e,t){return e.length>0&&t.length>0&&e.offset().top===t.offset().top},i=function(e,t,i,r){var n,s,a,o,u,c;return c=$(window).innerWidth(),o=t+i,u=c-2*r+i,s=Math.floor(u/o),n=c-(s*o-i),a=Math.floor(n/2),e.css({"margin-right":0,"margin-left":i}),e.each(function(e){return 0===e%s?$(this).css({"margin-left":a}):void 0})},this.gon={google_api_key:"AIzaSyCPyGutBfuX48M72FKpF4X_CxxPadq6r4w",acceptable_extensions:{audio:["mp3","ogg","aac","wav","amr","3ga","m4a","wma","mp4","mp2","flac"],image:["jpg","jpeg","gif","png","tiff","bmp"],video:["mp4","m4v","avi","ogv"]},development:!1},angular.module("Museum.controllers",[]).controller("IndexController",["$rootScope","$scope","$http","$filter","$window","$modal","$routeParams","$location","ngProgress","storySetValidation","errorProcessing","$i18next","imageMappingHelpers",function(r,n,s,a,o,u,c,l,m,d,_,g,p){var f,h,b,v,y,w,x,z;return window.sc=n,n.exhibit_search="",n.changeLng=function(e){return g.options.lng=e},n.criteriaMatch=function(e){return function(t){var i,r,s;return null!=t.stories[n.current_museum.language]?t.stories[n.current_museum.language].name?(i=t.stories[n.current_museum.language].name.toLowerCase().indexOf(e.toLowerCase())>-1,r=parseInt(t.number,10)===parseInt(e,10),s=i||""===e||r,s&&n.grid(),s):!0:!0}},n.statusMatch=function(){return function(e){return null!=e.stories[n.current_museum.language]?e.stories[n.current_museum.language].status&&n.exhibits_visibility_filter?e.stories[n.current_museum.language].status===n.exhibits_visibility_filter?!0:!1:!0:!0}},n.museum_change_progress=!0,m.color("#fd6e3b"),z=null!=l.$$path?l.$$path.split("/")[1]:"526e1baa0439f8b01a000002",f=null!=c.content_provider_id?c.content_provider_id:"526e1baa0439f8b01a000001",n.backend_url="http://prototype.izi.travel/api",n.sort_field="number",n.sort_direction=1,n.sort_text="Sort 0-9",n.ajax_progress=!0,n.story_subtab="video",n.story_tab="main",n.museum_tab="main",n.museum_subtab="video",n.reload_exhibits=function(e,t){return null==e&&(e=n.sort_field),null==t&&(t=n.sort_direction),s.get(""+n.backend_url+"/provider/"+f+"/museums/"+z+"/exhibits/"+e+"/"+t).success(function(e){var t,i,r,s,a,o,u,c,l,d,_,g,p,f,h,b;for(i=[],n.raw_data=e,o=0,d=e.length;d>o;o++)if(s=e[o],null!=s){for(t=s.exhibit,t.images=[],t.mapped_images=[],t.cover={},f=s.images,u=0,_=f.length;_>u;u++)r=f[u],t.images.push(r),r.image.cover===!0&&(t.cover=r.image);for(t.stories={},h=s.stories,c=0,g=h.length;g>c;c++){for(a=h[c],a.story.quiz=a.quiz.quiz,a.story.audio=a.audio,a.story.video=a.video,a.story.quiz.answers=a.quiz.answers,a.story.mapped_images=[],b=t.images,l=0,p=b.length;p>l;l++)r=b[l],r.mappings[a.story.language]&&a.story.mapped_images.push(r);t.stories[a.story.language]=a.story}i.push(t)}return m.complete(),console.log("anim completed"),n.active_exhibit=i[0],n.exhibits=i,n.ajax_progress=!1,0===i.length&&(n.active_exhibit={index:0,name:"Богоматерь Владимирская, с двунадесятыми праздниками",number:"1",image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",publish_state:"all",description:"",qr_code:{url:"/img/qr_code.png",print_link:"http://localhost:8000/img/qr_code.png"},images:[{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:1,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"},{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:2,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"}],stories:{ru:{name:"Богоматерь Владимирская, с двунадесятыми праздниками",description:"test description",publish_state:"all",audio:"http://www.jplayer.org/audio/ogg/TSP-01-Cro_magnon_man.ogg",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}}}}),n.museum_change_progress=!1})},n.reload_museums=function(){return m.start(),console.log("anim started"),s.get(""+n.backend_url+"/provider/"+f+"/museums").success(function(e){var t,i,r,s,a,o,u,c,l,m,d,_,p,f,h,b,v,y,w;for(n.museums=[],t=!1,n.langs=[],n.modal_translations={},c=0,_=e.length;_>c;c++){for(r=e[c],a=r.exhibit,a.def_lang="ru",null==a.language&&(a.language="ru"),a.package_status="process",a.stories={},a.images=[],a.mapped_images=[],a.cover={},b=r.images,l=0,p=b.length;p>l;l++)i=b[l],a.images.push(i),i.image.cover===!0&&(a.cover=i.image);for(v=r.stories,m=0,f=v.length;f>m;m++){for(o=v[m],o.story.city="Saint-Petersburg",o.story.quiz=o.quiz.quiz,o.story.audio=o.audio,o.story.video=o.video,o.story.quiz.answers=o.quiz.answers,o.story.mapped_images=[],y=a.images,d=0,h=y.length;h>d;d++)i=y[d],i.mappings[o.story.language]&&o.story.mapped_images.push(i);a.stories[o.story.language]=o.story,n.langs.push(o.story.language)}if(n.museums.push(a),a.active=!1,a._id===z){a.active=!0,n.current_museum=a,t=!0,w=a.stories;for(s in w)u=w[s],console.log(s),n.modal_translations[s]={name:g(s)}}}return t||(n.current_museum=n.museums[0],n.current_museum.def_lang="ru",null==a.language&&(n.current_museum.language="ru"),z=n.current_museum._id),n.reload_exhibits()})},n.reload_museum=function(){return s.get(""+n.backend_url+"/provider/"+f+"/museums/"+z).success(function(e){var t,i,r,s,a;for(t=e.exhibit,t.def_lang="ru",t.language="ru",t.stories={},a=e.stories,r=0,s=a.length;s>r;r++)i=a[r],i.story.quiz=i.quiz.quiz,i.story.quiz.answers=i.quiz.answers,i.story.images=i.images,i.story.audio=i.audio,t.stories[i.story.language]=i.story;return n.current_museum=t})},n.reload_museums(),n.museums=[{name:"Imperial Peace Museum",packege_status:"generated",city:"London",image:"/img/museum.jpg",type:"museum"},{name:"Imperial War Museum",packege_status:"generated",city:"Tokio",image:"/img/museum.jpg",type:"museum"},{name:"Imperial Peace Exhibitin",packege_status:"generated",city:"Moscow",image:"/img/museum.jpg",type:"museum"},{name:"Imperial War Exhibitin",packege_status:"generated",city:"Berlin",image:"/img/museum.jpg",type:"museum"},{name:"Republican Peace Museum",packege_status:"process",city:"Tokio",image:"/img/museum.jpg",type:"tour"},{name:"Republican Peace Exhibitin",packege_status:"process",city:"London",image:"/img/museum.jpg",type:"tour"},{name:"Republican War Museum",packege_status:"process",city:"Berlin",image:"/img/museum.jpg",type:"tour"},{name:"Republican War Exhibitin",packege_status:"process",city:"London",image:"/img/museum.jpg",type:"museum"}],n.user={mail:"pman89@yandex.ru",providers:[{name:"IZI.travel Test Provider"},{name:"IZI.travel Second Provider"}]},n.provider={name:"content_1",id:"1",passcode:"passcode",passcode_edit_link:"/1/pass/edit/"},n.translations={ru:"Russian",en:"English",es:"Spanish",ge:"German",fi:"Finnish",sw:"Sweedish",it:"Italian",fr:"French",kg:"Klingon"},n.modal_translations={},n.exhibits=[{index:0,name:"Богоматерь Владимирская, с двунадесятыми праздниками",number:"1",image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",publish_state:"all",long_description:"",qr_code:{url:"/img/qr_code.png",print_link:"http://localhost:8000/img/qr_code.png"},images:[{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:1,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"},{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:2,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"}],stories:{ru:{name:"Богоматерь Владимирская, с двунадесятыми праздниками",long_description:"test description",publish_state:"all",audio:"http://www.jplayer.org/audio/ogg/TSP-01-Cro_magnon_man.ogg",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}},en:{name:"Богоматерь Владимирская, с двунадесятыми праздниками",long_description:"test description",publish_state:"all",audio:"http://www.jplayer.org/audio/ogg/TSP-01-Cro_magnon_man.ogg",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}},es:{name:"Богоматерь Владимирская, с двунадесятыми праздниками",long_description:"test description",publish_state:"all",audio:"http://www.jplayer.org/audio/ogg/TSP-01-Cro_magnon_man.ogg",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}}}}],n.active_exhibit=n.exhibits[0],n.current_museum={language:"ru",def_lang:"ru",name:"Museum of modern art",index:2,number:3,image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",publish_state:"all",description:"",qr_code:{url:"/img/qr_code.png",print_link:"http://localhost:8000/img/qr_code.png"},images:[{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:1,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"},{image:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/14845c98-05ec-4da8-8aff-11808ecc123f_800x600.jpg",thumb:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg",id:2,edit_url:"http://media.izi.travel/fc85dcc2-3e95-40a9-9a78-14705a106230/7104d8b7-2f73-4b98-bfb2-b4245a325ce3_480x360.jpg"}],stories:{en:{name:"English",language:"en",publish_state:"all",long_description:"",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}},es:{name:"Spanish",language:"es",publish_state:"all",long_description:"",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}},ru:{name:"Russian",language:"ru",publish_state:"all",audio:"http://www.jplayer.org/audio/ogg/TSP-01-Cro_magnon_man.ogg",long_description:"",quiz:{question:"are you sure?",description:"can you tell me?",state:"published",answers:[{title:"yes",correct:!1,id:0},{title:"may be",correct:!0,id:1},{title:"who cares?",correct:!1,id:2},{title:"nope",correct:!1,id:3}]}}},new_story_link:"/1/1/1/"},n.element_switch=!0,n.forbid_switch=!1,n.create_new_language=!1,h=$("#drop_down").removeClass("hidden").hide(),b=function(){return $("ul.exhibits li.exhibit.active")},n.dummy_focusout_process=function(){var e,t,i,r,s;if(""===h.find("#name").val()){for(t=!0,s=h.find("#media .form-control:not(#opas_number)"),i=0,r=s.length;r>i;i++)e=s[i],e=$(e),""!==e.val()&&(t=!1);return t?n.new_item_creation=!1:n.dummy_modal_open()}},n.closeDropDown=function(){var e;return console.log("closing"),e=b(),null!=n.active_exhibit&&(n.active_exhibit.active=!1),e.hasClass("dummy")&&n.dummy_focusout_process(e),h.hide(),e.removeClass("active")},n.attachDropDown=function(e){var i;return e=$(e),i=h.hasClass("inited"),h.show().insertAfter(t(e)),i?void 0:(h.addClass("inited"),h.find("a.done, .close").not(".delete_maping").unbind("click").bind("click",function(e){return e.preventDefault(),n.closeDropDown()}),h.find(">.prev-ex").unbind("click").bind("click",function(e){var t,i;return e.preventDefault(),t=b(),i=t.prev(".exhibit"),("drop_down"===i.attr("id")||i.hasClass("dummy"))&&(i=i.prev()),i.length>0?i.find(".opener .description").click():t.siblings(".exhibit").last().find(".opener").click()}),h.find(">.next-ex").unbind("click").bind("click",function(e){var t,i;return e.preventDefault(),t=b(),i=t.next(),("drop_down"===i.attr("id")||i.hasClass("dummy"))&&(i=i.next()),i.length>0?i.find(".opener .description").click():t.siblings(".exhibit").first().find(".opener").click()}),h.find("a.delete_story").unbind("click").bind("click",function(e){var t;return t=$(this),t.hasClass("no_margin")?(e.preventDefault(),e.stopPropagation(),n.closeDropDown()):void 0}))},n.open_dropdown=function(t,i){var r,s,a,o,u,c,l,m,d;if(r=$(t.target).parents("li"),n.element_switch=!0,n.forbid_switch===!0)return t.stopPropagation(),!1;if(r.hasClass("active")&&!n.new_item_creation)return n.closeDropDown(),!1;for(n.new_item_creation&&(n.story_tab="main",b().length>0&&n.closeDropDown()),d=n.exhibits,l=0,m=d.length;m>l;l++)a=d[l],null!=a&&(a.active=!1);return i.active=!0,setTimeout(function(){return n.element_switch=!1},500),n.active_exhibit=i,c=b(),c.hasClass("dummy")&&n.dummy_focusout_process(c),c.removeClass("active"),r.addClass("active"),e(r,c)||(n.attachDropDown(r),setTimeout(function(){return $.scrollTo(r,500)},100)),o=h.find(".item_publish_settings"),s=h.find(".delete_story"),"images"===n.story_tab&&(n.story_tab="main"),r.hasClass("dummy")?(u=r.data("number"),$("#opas_number").val(u).blur(),$("#name").focus(),o.hide(),s.addClass("no_margin")):(o.show(),s.removeClass("no_margin"))},n.museum_type_filter="",n.grid=function(){var e,t,r,n;return e=$(".exhibits>li.exhibit"),t=60,n=e.first().width(),r=40,i(e,n,r,t)},n.museum_list_prepare=function(){var e,t,i,r;return t=$("ul.museum_list"),e=t.find("li").length,r=$("body").width(),i=(150*e+160)/r,i>1?($(".museum_filters").show(),t.width(r-200)):($(".museum_filters").hide(),t.width(r-100))},setTimeout(function(){return n.museum_list_prepare()},200),$(window).resize(function(){return setTimeout(function(){return n.museum_list_prepare()},100)}),n.new_item_creation=!1,n.all_selected=!1,n.modal_options={current_language:{name:n.translations[n.current_museum.language],language:n.current_museum.language},languages:n.modal_translations,exhibits:n.exhibits,deletion_password:"123456"},w=function(){var e;return e=0,e=n.exhibits[n.exhibits.length-1]?parseInt(n.exhibits[n.exhibits.length-1].number,10)+1:1},v=function(){return n.current_museum.language},x=function(e){return e===n.current_museum.language?"passcode":"dummy"},y=function(e){return e===n.current_museum.language?"Экспонат_"+e:""},n.set_hover=function(e,t){return e.image.hovered=t},n.check_mapped=function(e){var t,i,r,s;return r=$(e.target),i=r.parents(".description").find(".timline_container"),s=r.hasClass("active_exhibit")?n.active_exhibit:r.hasClass("current_museum")?n.current_museum:void 0,s.stories[n.current_museum.language].mapped_images.length>0?(t=s.stories[n.current_museum.language],setTimeout(function(){return n.recalculate_marker_positions(t,i)},100)):void 0},n.delete_mapping=function(e,t){var i,r;return i=n.active_exhibit.images[e],r=n.current_museum.language,s["delete"](""+n.backend_url+"/media_mapping/"+i.mappings[r]._id).success(function(t){var s,a,o,u,c,l,m,d,_,g;for(console.log("ok",t),d=n.active_exhibit.stories[r].mapped_images,o=u=0,l=d.length;l>u;o=++u)if(a=d[o],a.image._id===i.image._id){n.active_exhibit.stories[r].mapped_images.splice(o,1);break}for(delete i.mappings[r],n.active_exhibit.images.sort(p.sort_weight_func).sort(p.sort_time_func),_=n.active_exhibit.images,g=[],e=c=0,m=_.length;m>c;e=++c)s=_[e],s.image.order=e,g.push(p.update_image(s,n.backend_url));return g}).error(function(){return _.addError(g("Failed to delete timestamp"))}),t.preventDefault(),t.stopPropagation()},n.recalculate_marker_positions=function(e){var t,i,r,s,a,o,u,c,l,m,d,_,g,p,f;for(m=$(".jp-seek-bar:visible"),a=$(".jp-duration:visible"),o=$(".jp-play:visible"),i=o.width(),t=m.width()-15,r=a.text(),d=parseInt(r.split(":")[1],10)+60*parseInt(r.split(":")[0],10),l=d/t,p=$(".image_connection:visible"),f=[],_=0,g=p.length;g>_;_++)c=p[_],c=$(c),s=e.mapped_images[c.data("image-index")],u=s.mappings[n.current_museum.language].timestamp/l,f.push(c.css({left:""+(u+i)+"px"}));return f},n.create_dummy_story=function(e){var t,i,r;for(t={playback_algorithm:"generic",content_provider:f,story_type:"story",status:"draft",language:"dummy",name:"",short_description:"",long_description:"",story_set:e},t.quiz={story:"",question:"",comment:"",status:"passcode",answers:[]},i=r=0;3>=r;i=++r)t.quiz.answers.push({quiz:"",content:"",correct:!1});return t.quiz.answers[0].correct=!0,t},n.new_museum_language=function(){var e,t;return n.create_new_language=!0,t=n.create_dummy_story(n.current_museum._id),t.quiz.answers[0].correct=!0,n.dummy_museum=angular.copy(n.current_museum),n.dummy_museum.stories.dummy=t,n.dummy_museum.stories.dummy.status="passcode",n.dummy_museum.language="dummy",n.modal_options={museum:n.dummy_museum,translations:n.translations},e=u.open({templateUrl:"myMuseumModalContent.html",controller:ModalMuseumInstanceCtrl,resolve:{modal_options:function(){return n.modal_options}}}),e.result.then(function(e){var t,i;switch(e){case"save":return console.log(n.dummy_museum),t=n.dummy_museum.language,n.dummy_museum.stories[t]=n.dummy_museum.stories.dummy,n.dummy_museum.stories[t].language=t,i=n.dummy_museum.stories[t],i.story_set=n.current_museum._id,n.post_stories(i,"uncommon",function(e){var r,s,a,o,u;for(e.quiz=i.quiz,u=n.exhibits,a=0,o=u.length;o>a;a++)r=u[a],r.stories[t]=angular.copy(i),r.stories[t].language=t,r.stories[t].name="",r.stories[t].status="draft",r.stories[t].story_set=r._id,s=angular.copy(r.stories[t]),n.post_stories(s,"uncommon");return n.current_museum.stories[t]=e,n.modal_translations[t]={name:n.translations[t]},n.current_museum.language=t,n.create_new_language=!1});case"discard":return!0}},function(){return console.log("Modal dismissed at: "+new Date)}),!0},n.create_new_item=function(){var e,t,i,r,s;if(n.new_item_creation!==!0){r=w(),n.new_exhibit={content_provider:f,number:r,type:"exhibit",distance:20,duration:20,status:"draft",route:"",category:"",parent:z,name:"",qr_code:{url:"",print_link:""},stories:{}},n.new_exhibit.images=[];for(i in n.current_museum.stories){for(n.new_exhibit.stories[i]={playback_algorithm:"generic",content_provider:f,story_type:"story",status:"draft",language:i,name:"",short_description:"",long_description:"",story_set:""},n.new_exhibit.stories[i].quiz={story:"",question:"",comment:"",status:"passcode",answers:[]},t=s=0;3>=s;t=++s)n.new_exhibit.stories[i].quiz.answers.push({quiz:"",content:"",correct:!1});n.new_exhibit.stories[i].quiz.answers[0].correct=!0}return n.new_item_creation=!0,n.story_tab="main",e={},e.target=$("li.exhibit.dummy > .opener.draft"),console.log($("li.exhibit.dummy")),n.open_dropdown(e,n.new_exhibit),n.grid()}},n.check_selected=function(){var e,t,i,r,s;for(e=0,n.select_all_enabled=!1,s=n.exhibits,i=0,r=s.length;r>i;i++)t=s[i],t.selected===!0&&(n.select_all_enabled=!0,e+=1);return e===n.exhibits.length?n.all_selected=!0:void 0},n.select_all_exhibits=function(e){var t,i,r,s,a;if(null!=e)switch(e){case"select":i=!0;break;case"cancel":i=!1}else i=!n.all_selected;for(a=n.exhibits,r=0,s=a.length;s>r;r++)t=a[r],t.selected=i;return n.all_selected=!n.all_selected,n.select_all_enabled=i},n.delete_modal_open=function(){var e;return n.new_item_creation?!0:(n.modal_options={current_language:{name:n.translations[n.current_museum.language],language:n.current_museum.language},languages:n.modal_translations,exhibits:n.exhibits,deletion_password:"123456"},e=u.open({templateUrl:"myModalContent.html",controller:ModalDeleteInstanceCtrl,resolve:{modal_options:function(){return n.modal_options}}}),e.result.then(function(e){return n.delete_exhibit(n.active_exhibit,e.selected)},function(){return console.log("Modal dismissed at: "+new Date)}))},n.delete_museum_modal_open=function(){var e;return n.new_item_creation?!0:(n.modal_options={current_language:{name:n.translations[n.current_museum.language],language:n.current_museum.language},languages:n.modal_translations,exhibits:n.exhibits,deletion_password:"123456"},e=u.open({templateUrl:"museumDelete.html",controller:museumDeleteCtrl,resolve:{modal_options:function(){return n.modal_options}}}),e.result.then(function(e){var t,i,r,s,a,o,u,c,l;if(i=n.current_museum.language,"lang"===e){for(delete n.modal_translations[i],n.current_museum.language=n.current_museum.def_lang,c=n.exhibits,s=0,o=c.length;o>s;s++)t=c[s],n.delete_story(t.stories,i,function(e,t){return delete e[t],!0});return n.delete_story(n.current_museum.stories,i,function(e,t){return delete e[t],!0})}for(console.log("deleting museum story or whole museum"),r=n.current_museum,l=n.exhibits,a=0,u=l.length;u>a;a++)t=l[a],n.delete_story_set(t);return n.delete_story_set(r)},function(){return console.log("Modal dismissed at: "+new Date)}))},n.delete_exhibit=function(e,t){var i,r,s,a,o,u,c,l,m,d,_;if(t.length>=Object.keys(e.stories).length){for(n.closeDropDown(),l=n.exhibits,d=[],r=u=0,c=l.length;c>u;r=++u){if(i=l[r],i._id===e._id){n.exhibits.splice(r,1),n.grid(),e._id===n.active_exhibit._id&&(n.active_exhibit=n.exhibits[0]),n.delete_story_set(e);break}d.push(void 0)}return d}console.log(e._id),m=e.stories,_=[];for(a in m)o=m[a],_.push(function(){var i,r,u;for(u=[],i=0,r=t.length;r>i;i++)s=t[i],s===a?(e.selected=!1,o=e.stories[a],o.status="draft",o.name="",o.short_description="",o.long_description="",o.quiz.question="",o.quiz.comment="",o.quiz.status="",o.quiz.answers||(o.quiz.answers=[]),o.quiz.answers[0].content="",o.quiz.answers[0].correct=!0,o.quiz.answers[1].content="",o.quiz.answers[1].correct=!1,o.quiz.answers[2].content="",o.quiz.answers[2].correct=!1,o.quiz.answers[3].content="",o.quiz.answers[3].correct=!1,u.push(n.update_story(o))):u.push(void 0);return u}());return _},n.dummy_modal_open=function(){var e;return e=u.open({templateUrl:"myDummyModalContent.html",controller:ModalDummyInstanceCtrl,resolve:{modal_options:function(){return{exhibit:n.active_exhibit}}}}),e.result.then(function(e){return n.new_item_creation=!1,n.item_deletion=!0,"save_as"===e?(n.new_exhibit.stories[n.current_museum.language].name="item_"+n.new_exhibit.number,n.new_exhibit.stories[n.current_museum.language].publish_state="passcode",n.new_exhibit.active=!1,n.exhibits.push(n.new_exhibit)):(n.closeDropDown(),n.new_exhibit.active=!1,n.active_exhibit=n.exhibits[0]),n.item_deletion=!1},function(){return console.log("Modal dismissed at: "+new Date)})},n.show_museum_edit=function(e){var t,i;return t=$(e.target),i||(i=!0,$(".navigation .museum_edit").slideToggle(1e3,"easeOutQuint"),n.museum_edit_dropdown_opened=!n.museum_edit_dropdown_opened),!1},n.museum_edit_dropdown_close=function(){var e;return e={target:$(".museum_edit_opener")},n.museum_edit_dropdown_opened?n.show_museum_edit(e):void 0},n.update_story=function(e){return s.put(""+n.backend_url+"/story/"+e._id,e).success(function(){return s.put(""+n.backend_url+"/quiz/"+e.quiz._id,e.quiz).success(function(){var t,i,r,s,a;for(s=e.quiz.answers,a=[],i=0,r=s.length;r>i;i++)t=s[i],a.push(n.put_answers(t));return a}).error(function(){return _.addError(g("Failed to update a quiz for story"))})}).error(function(){return _.addError(g("Failed update a story"))})},n.put_answers=function(e){return s.put(""+n.backend_url+"/quiz_answer/"+e._id,e).success(function(){return console.log("done")}).error(function(){return _.addError(g("Failed to save quiz answer"))})},n.post_stories=function(e,t,i){var r;return null==t&&(t="common"),r="common"===t?e:angular.copy(e),s.post(""+n.backend_url+"/story/",r).success(function(e){return r._id=e._id,r.quiz.story=e._id,null!=i&&i(e),s.post(""+n.backend_url+"/quiz/",r.quiz).success(function(e){var t,i,s,a,o;for(r.quiz._id=e.id,a=r.quiz.answers,o=[],i=0,s=a.length;s>i;i++)t=a[i],t.quiz=e._id,o.push(n.post_answers(t));return o}).error(function(){return _.addError(g("Failed to save quiz for new story"))})}).error(function(){return _.addError(g("Failed to save new story"))})},n.post_answers=function(e){return s.post(""+n.backend_url+"/quiz_answer/",e).success(function(t){return e._id=t._id}).error(function(){return _.addError(g("Failed to save quiz answer"))})},n.mass_switch_pub=function(e){var t,i,r,s,a,o;for(a=n.exhibits,o=[],r=0,s=a.length;s>r;r++)t=a[r],t.selected===!0&&"dummy"!==t.stories[n.current_museum.language].status?(i={},i.item=t.stories[n.current_museum.language],i.root=t,i.field_type="story",i.item.status=e,o.push(d.checkValidity(i))):o.push(void 0);return o},n.delete_selected_exhibits=function(){var e;return n.modal_options={current_language:{name:n.translations[n.current_museum.language],language:n.current_museum.language},languages:n.modal_translations,exhibits:n.exhibits,deletion_password:"123456"},e=u.open({templateUrl:"myModalContent.html",controller:ModalDeleteInstanceCtrl,resolve:{modal_options:function(){return n.modal_options}}}),e.result.then(function(e){var t,i,r,s,a;for(console.log(e.ids_to_delete),s=e.ids_to_delete,a=[],i=0,r=s.length;r>i;i++)t=s[i],t.selected===!0?(t.selected=!1,a.push(n.delete_exhibit(t,e.selected))):a.push(void 0);return a},function(){return console.log("Modal dismissed at: "+new Date)})},n.delete_story=function(e,t,i){return s["delete"](""+n.backend_url+"/story/"+e[t]._id).success(function(r){return console.log(r),null!=i?i(e,t):void 0}).error(function(){return _.addError(g("Failed to delete story in languane: ")+n.translations[t])})},n.delete_story_set=function(e){return s["delete"](""+n.backend_url+"/story_set/"+e._id+"/").success(function(e){return console.log(e)}).error(function(){return _.addError(g("Failed to delete exhibit with number ")+e.number)})},n.$watch("current_museum.language",function(e){if(console.log(e),r.lang=e,e){if("dummy"===e)return console.log("dummy"),n.modal_options.current_language={name:n.translations[n.current_museum.language],language:n.current_museum.language},n.create_new_language=!1;if(console.log("not dummy"),n.current_museum._id)return s.put(""+n.backend_url+"/story_set/"+n.current_museum._id,n.current_museum).success(function(e){return console.log(e),n.last_save_time=new Date}).error(function(){return _.addError(g("Failed to save museum language"))})}}),n.$on("save_new_exhibit",function(){return console.log("saving!"),n.new_exhibit.stories[n.current_museum.language].status="passcode",s.post(""+n.backend_url+"/story_set/",n.new_exhibit).success(function(e){var t,i,r;n.exhibits.push(n.new_exhibit),n.new_exhibit._id=e._id,n.last_save_time=new Date,r=n.new_exhibit.stories;for(t in r)i=r[t],i.publish_state="passcode",i.story_set=e._id,n.post_stories(i);return h.find(".item_publish_settings").show()}).error(function(){return _.addError(g("Failed to save new exhibit"))}),n.new_item_creation=!1,n.$digest()}),n.$on("changes_to_save",function(e,t){return t.item._id?(s.put(""+n.backend_url+"/"+t.field_type+"/"+t.item._id,t.item).success(function(e){return t.satus="done",n.last_save_time=new Date,console.log(e)}).error(function(){return _.addError(g("Server error - Prototype error."))}),n.forbid_switch=!1):void 0}),n.$on("quiz_changes_to_save",function(e,t,i){var r,a,o,u,c;for(c=t.collection,o=0,u=c.length;u>o;o++)a=c[o],r=a._id===i._id?!0:!1,a.correct=r,a.correct_saved=r,s.put(""+n.backend_url+"/"+t.field_type+"/"+a._id,a).success(function(e){return console.log(e),n.last_save_time=new Date}).error(function(){return _.addError(g("Failed to update quiz"))});return n.forbid_switch=!1}),n.$watch("exhibits_visibility_filter",function(e,t){return null!=e&&e!==t?n.closeDropDown():void 0}),n.$watch("exhibit_search",function(e,t){return null!=e&&e!==t?n.closeDropDown():void 0}),n.$watch("current_museum.invalid",function(e){return console.log(null!=e,e),null!=e&&e&&setTimeout(function(){return n.museum_edit_dropdown_opened?void 0:$(".museum_edit_opener").click()},10),!0}),n.$watch(function(){return l.path()},function(e,t){var i,r,s,a,o,u,c;if(null!=e&&e!==t){for(n.closeDropDown(),$(".museum_navigation_menu").slideUp(300),m.complete(),m.start(),console.log("anim started"),n.museum_change_progress=!0,z=e.split("/")[1],n.modal_translations={},u=n.museums,a=0,o=u.length;o>a;a++)if(r=u[a],r._id===z){r.active=!0,n.current_museum=r,c=r.stories;for(i in c)s=c[i],n.modal_translations[i]={name:g(i)}}else r.active=!1;return n.reload_exhibits()}}),n.$watch("museum_change_progress",function(e){return null!=e?e?($(".page-wrapper .page").fadeOut(300),$(".page-preloader").fadeIn(300)):($(".page-wrapper .page").fadeIn(300),$(".page-preloader").fadeOut(300)):void 0})}]).controller("MuseumEditController",["$scope","$http","$filter","$window","$modal","storage",function(e){return setTimeout(function(){return e.$parent.museumQuizform=e.museumQuizform,e=e.$parent},100),e.$watch("current_museum.stories[current_museum.language].quiz",function(t){if("limited"===t.state){if(!$("#museum_story_quiz_disabled").is(":checked"))return setTimeout(function(){return $("#museum_story_quiz_disabled").click()},10)}else if("published"===t.state)return $("#museum_story_quiz_enabled").is(":checked")?setTimeout(function(){return e.museumQuizform.$valid?void 0:setTimeout(function(){return $("#museum_story_quiz_disabled").click()},10)},100):setTimeout(function(){return $("#museum_story_quiz_enabled").click()},10)},!0),e.$watch("current_museum.stories[current_museum.language].quiz.question",function(){return null!=e.museumQuizform?e.museumQuizform.$valid?e.mark_quiz_validity(e.museumQuizform.$valid):setTimeout(function(){return $("#museum_story_quiz_disabled").click(),e.mark_quiz_validity(e.museumQuizform.$valid)},10):void 0}),e.$watch(function(){return angular.toJson(e.current_museum.stories[e.current_museum.language].quiz.answers)},function(){return null!=e.museumQuizform?e.museumQuizform.$valid?e.mark_quiz_validity(e.museumQuizform.$valid):setTimeout(function(){return $("#museum_story_quiz_disabled").click()},10):void 0},!0),!0}]),this.ModalDeleteInstanceCtrl=function(e,t,i){return e.modal_options=i,e.deletion_password="",console.log(e.modal_options.languages),e.only_one=1===Object.keys(e.modal_options.languages).length,e.password_input_shown=!1,e.ok=function(){var r,n,s,a,o,u,c,l;e.selected=[],e.ids_to_delete=[],c=e.modal_options.languages;for(n in c)a=c[n],a.checked===!0&&e.selected.push(n);for(l=i.exhibits,o=0,u=l.length;u>o;o++)r=l[o],r.selected===!0&&e.ids_to_delete.push(r);return s={ids_to_delete:e.ids_to_delete,selected:e.selected},e.ids_to_delete.length<=1?t.close(s):(e.password_input_shown=!0,e.deletion_password===i.deletion_password?t.close(s):void 0)
},e.cancel=function(){return t.dismiss()},e.mark_all=function(){var t,i,r,n;r=e.modal_options.languages,n=[];for(t in r)i=r[t],n.push(i.checked=!0);return n},e.mark_default_only=function(){var t,i,r,n;r=e.modal_options.languages,n=[];for(t in r)i=r[t],i.checked=!1,e.modal_options.current_language.language===t?n.push(i.checked=!0):n.push(void 0);return n},e.mark_default_only()},this.museumDeleteCtrl=function(e,t,i){return e.modal_options=i,e.deletion_password="",e.variant={checked:"lang"},e.ok=function(){return e.deletion_password===i.deletion_password?t.close(e.variant.checked):void 0},e.cancel=function(){return t.dismiss()}},this.ModalDummyInstanceCtrl=function(e,t,i){return e.exhibit=i.exhibit,e.discard=function(){return t.close("discard")},e.save_as=function(){return t.close("save_as")}},this.ModalMuseumInstanceCtrl=function(e,t,i){return e.museum=i.museum,e.translations=i.translations,e.discard=function(){return t.close("discard")},e.save_as=function(){return t.close("save",e.museum)}}}).call(this);