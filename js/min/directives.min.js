(function(){"use strict";angular.module("Museum.directives",[]).directive("ngBlur",function(){return function(e,t,n){return t.bind("blur",function(){return e.$apply(n.ngBlur)})}}).directive("ngFocus",function(e){return function(t,n,i){return t.$watch(i.ngFocus,function(t){return t?e(function(){return n[0].focus()},0,!1):void 0})}}).directive("focusMe",function(e,t){return{link:function(n,i,r){var o;return o=t(r.focusMe),n.$watch(o,function(t){return t===!0?e(function(){return i[0].focus()}):void 0}),i.bind("blur",function(){return n.$apply(o.assign(n,!1))})}}}).directive("stopEvent",function(){return{link:function(e,t,n){return t.bind(n.stopEvent,function(e){return e.stopPropagation()})}}}).directive("resizer",function(){return{restrict:"A",link:function(e,t){var n;return n=$(t),n.focus(function(){return n.animate({width:"+=150"},200)}),n.blur(function(){return n.animate({width:"-=150"},200)})}}}).directive("toggleMenu",function(){return{restrict:"A",link:function(e,t){var n;return n=$(t),n.click(function(){return $(".museum_navigation_menu").slideToggle(300),setTimeout(function(){return $.scrollTo(0,0)},0)})}}}).directive("toggleFilters",function(){return{restrict:"A",link:function(e,t){var n;return n=$(t),n.click(function(){var t,n;return t=$(".filters_bar"),n=t.css("top"),"0px"===n?t.animate({top:"-44px"},300):t.animate({top:"0px"},300),e.filters_opened=!e.filters_opened})}}}).directive("postRender",function(e){return{restrict:"A",link:function(t){return t.$last&&e(t.grid,200),!0}}}).directive("switchpubitem",function(){return{restrict:"E",replace:!0,transclude:!0,require:"?ngModel",scope:{item:"=ngItem",provider:"=ngProvider",current_museum:"=ngMuseum",trans:"=translations",field:"@field",field_type:"@type",root:"=root"},template:'<div class="btn-group pull-right item_publish_settings" ng-hide="item.status == \'draft\'">\n  <button class="btn btn-success" ng-class="{\'active\': item.status == \'published\' }" ng-click="item.status = \'published\'; status_process()" type="button" ng-switch on="item[field]">\n    <div class="extra" ng-switch on="item[field]">\n      <i class="icon-globe"></i>\n    </div>\n    <span ng-switch-when="passcode">Publish</span>\n    <span ng-switch-when="published">Published</span>\n  </button>\n  <button class="btn btn-success" ng-class="{\'active\': item.status == \'passcode\' }" ng-click="item.status = \'passcode\'; status_process()" type="button" ng-switch on="item[field]">\n    <div class="extra" ng-switch on="item[field]">\n      <i class="icon-lock"></i>\n    </div>\n    <span ng-switch-when="passcode">Private</span>\n    <span ng-switch-when="published">Make private</span>\n  </button>\n</div>',controller:function(e,t,n,i,r){return e.status_process=function(){return r.checkValidity(e)}},link:function(e){return e.hidden_list=!0,!0}}}).directive("switchpub",function(){return{restrict:"E",replace:!0,transclude:!0,require:"?ngModel",scope:{item:"=ngItem",provider:"=ngProvider",field:"@field",field_type:"@type",root:"=root"},template:'<div class="btn-group pull-right">\n  <button class="btn btn-default dropdown-toggle" data-toggle="dropdown" type="button">\n    <div class="extra_right" ng-switch on="item[field]">\n      <i class="icon-globe" ng-switch-when="published" ></i>\n      <i class="icon-lock" ng-switch-when="passcode" ></i>\n    </div>\n    <span class="caret"></span></button>\n  <ul class="dropdown-menu pull-left" role="menu" >\n    Who can see it in mobile application\n    <li class="divider"></li>\n    <li  ng-click="item[field] = \'published\'; status_process()">\n      <span class="check"><i ng-show="item[field] == \'published\'" class="icon-ok"></i></span>\n      <i class="icon-globe"></i> Everyone\n    </li>\n    <li ng-click="item[field] = \'passcode\'; status_process()">\n      <span class="check"><i ng-show="item[field] == \'passcode\'" class="icon-ok"></i></span>\n      <i class="icon-lock"></i> Only users who have passcode\n      <div class="limited-pass-hint hidden">\n        <div class="limited-pass">\n          {{provider.passcode}}\n        </div>\n        <a href="{{provider.passcode_edit_link}}" target="_blank">Edit</a>\n      </div>\n    </li>\n  </ul>\n</div>',controller:function(e,t,n,i,r){return e.status_process=function(){return r.checkValidity(e)}},link:function(){return!0}}}).directive("newLangSwitch",function(){return{restrict:"E",replace:!0,scope:{museum:"=museum"},template:'<div class="form-group">\n  <label class="col-xs-2 control-label" for="museum_language_select">Language</label>\n  <div class="help ng-scope" popover="Select language" popover-animation="true" popover-placement="bottom" popover-trigger="mouseenter">\n    <i class="icon-question-sign"></i>\n  </div>\n  <div class="col-xs-6 triggered">\n    <select class="form-control" ng-model="museum.language">\n      <option disabled="" selected="" value="dummy">Select a new language</option>\n      <option value="{{translation}}" ng-repeat="(translation, lang) in $parent.$parent.translations">{{lang}}</option>\n    </select>\n </div>\n</div>',controller:function(){return!0},link:function(e){return e.$watch("museum.language",function(e){return null!=e&&"new_lang"!==e?console.log("select",e):void 0}),!0}}}).directive("placeholderfield",function(e){return{restrict:"E",replace:!0,require:"?ngModel",scope:{item:"=ngItem",help:"@ngHelp",id:"@ngId",title:"@ngTitle",field:"@ngField",inv_sign:"=invalidsign",placeholder:"=placeholder",field_type:"@type"},template:'<div class="form-group textfield {{field}}">\n  <label class="col-xs-2 control-label" for="{{id}}" ng-click="edit_mode = false">{{title}}</label>\n  <div class="help" popover="{{help}}" popover-placement="bottom" popover-animation="true" popover-trigger="mouseenter">\n    <i class="icon-question-sign"></i>\n  </div>\n  {{active_exhibit}}\n  <span class="empty_name_error {{field}}">can\'t be empty</span>\n  <div class="col-xs-7 trigger">\n    <span class="placeholder" ng-click="update_old()">{{item[field]}}</span>\n  </div>\n  <div class="col-xs-7 triggered">\n    <input type="hidden" id="original_{{id}}" ng-model="item[field]" required>\n    <input type="text" class="form-control" id="{{id}}" value="{{item[field]}}" placeholder="{{placeholder}}">\n    <div class="error_text {{field}}" >can\'t be blank</div>\n  </div>\n  <status-indicator ng-binding="status"></statusIndicator>\n</div>',controller:function(e,t){return null==e.item.statuses&&(e.item.statuses={}),e.status=e.item.statuses[e.item.field],e.update_old=function(){return e.oldValue=e.item[e.field]},e.status_process=function(){return e.item[e.field]!==e.oldValue?(e.status="progress",e.$digest(),e.$parent.new_item_creation&&"name"===e.field&&e.item[e.field]&&0!==e.item[e.field].length?(t.$broadcast("save_new_exhibit"),!0):t.$broadcast("changes_to_save",e)):void 0}},link:function(t,n){var i,r,o;return n=$(n),r=n.find(".trigger"),o=n.find(".triggered"),i=n.find(".triggered > .form-control"),n.find("span.placeholder").click(function(){return r.hide(),o.show(),i.val(t.item[t.field]),i.focus(),i.removeClass("ng-invalid")}),n.find(".triggered > .form-control").blur(function(){var n;return n=$(this),t.$parent.new_item_creation&&"number"===t.field||e(function(){return t.item[t.field]=n.val(),t.$digest(),t.status_process()},0,!1),n.val().length>0?(o.hide(),r.show()):(n.addClass("ng-invalid"),"name"===t.field&&"dummy"!==t.item.status?e(function(){return n.val(t.oldValue),t.item[t.field]=t.oldValue,t.$digest(),o.hide(),r.show(),t.status_process()},0,!1):void 0)}),n.find(".triggered > .form-control").keyup(function(){var i,r;return i=$(this),r=i.val(),""===r&&"name"===t.field&&e(function(){return i.val(t.oldValue),t.item[t.field]=t.oldValue,t.$digest(),n.find(".error_text").show(),setTimeout(function(){return n.find(".error_text").hide()},2e3),t.status_process()},0,!1),!0}),t.$watch("item[field]",function(e){var n;if(t.status="",n="number"===t.field?null!=e:e){if(t.$parent.element_switch===!0)return r.show(),o.hide()}else if(r.hide(),o.show(),i.val(""),"name"===t.filed)return o.find(".form-control").focus()}),!0}}}).directive("placeholdertextarea",function(e){return{restrict:"E",replace:!0,require:"?ngModel",scope:{item:"=ngItem",help:"@ngHelp",id:"@ngId",title:"@ngTitle",field:"@ngField",max_length:"@maxlength",placeholder:"=placeholder",field_type:"@type"},template:'<div class="form-group textfield large_field">\n  <label class="col-xs-2 control-label" for="{{id}}" ng-click="edit_mode = false">\n    {{title}}\n    <span class="label label-danger" ng-show="field == \'long_description\' && item[field].length == 0">Fill to publish</span>\n  </label>\n  <div class="help" popover="{{help}}" popover-placement="bottom" popover-animation="true" popover-trigger="mouseenter">\n    <i class="icon-question-sign"></i>\n  </div>\n  <div class="col-xs-7 trigger">\n    <div class="placeholder large" ng-click="update_old()">{{item[field]}}</div>\n  </div>\n  <div class="col-xs-7 triggered">\n    <input type="hidden" id="original_{{id}}" ng-model="item[field]" required">\n    <div class="content_editable" contenteditable="true" id="{{id}}" placeholder="{{placeholder}}">{{item[field]}}</div>\n  </div>\n  <span class="sumbols_left">\n    {{length_text}}\n  </span>\n  <status-indicator ng-binding="status"></statusIndicator>\n</div>',controller:function(e,t){return null==e.item.statuses&&(e.item.statuses={}),e.status=e.item.statuses[e.item.field],e.update_old=function(){return e.oldValue=e.item[e.field]},e.status_process=function(){return e.item[e.field]!==e.oldValue?(e.status="progress",e.$digest(),t.$broadcast("changes_to_save",e)):void 0}},link:function(t,n){var i,r,o,s;return t.length_text="осталось символов: "+t.max_length,n=$(n),o=n.find(".trigger"),s=n.find(".triggered"),r=n.find(".sumbols_left"),i=s.children(".content_editable"),n.find("div.placeholder").click(function(){return o.hide(),s.show(),i.text(t.item[t.field]),i.focus(),t.length_text="осталось символов: "+(t.max_length-i.text().length-1),r.show()}),i.blur(function(){var n;return n=$(this),e(function(){return t.item[t.field]=n.text(),t.$digest(),t.status_process()},0,!1),""!==n.text()?(s.hide(),o.show(),r.hide(),t.status_process()):void 0}),i.keyup(function(){var e,n;return e=$(this),n=e.text(),n.length>=t.max_length&&e.text(n.substr(0,t.max_length-1)),t.length_text="осталось символов: "+(t.max_length-n.length-1),t.$digest()}),t.$watch("item[field]",function(e){return e?(t.max_length||(t.max_length=255),t.$parent.element_switch===!0&&(o.show(),s.hide()),!0):(t.length_text="осталось символов: 255",i.text(""),o.hide(),s.show())}),!0}}}).directive("quizanswer",function(){return{restrict:"E",replace:!0,require:"?ngModel",scope:{item:"=ngItem",collection:"=ngCollection",id:"@ngId",field:"@field",field_type:"@type"},template:'<div class="form-group textfield string optional checkbox_added">\n  <label class="string optional control-label col-xs-2" for="{{id}}">\n    <span class=\'correct_answer_indicator\'>correct</span>\n  </label>\n  <input class="coorect_answer_radio" name="correct_answer" type="radio" value="{{item._id}}" ng-model="checked" ng-click="check_items(item)">\n  <div class="col-xs-5 trigger">\n    <span class="placeholder" ng-click="update_old()">{{item[field]}}</span>\n  </div>\n  <div class="col-xs-5 triggered">\n    <input class="form-control" id="{{id}}" name="{{item._id}}" placeholder="Enter option" type="text" ng-model="item[field]" required>\n    <div class="error_text">can\'t be blank</div>\n  </div>\n  <status-indicator ng-binding="status"></statusIndicator>\n</div>',controller:function(e,t){return null==e.item.statuses&&(e.item.statuses={}),e.status=e.item.statuses[e.item.content],null==e.item.correct_saved&&(e.item.correct_saved=!1),e.check_items=function(n){return t.$broadcast("quiz_changes_to_save",e,n)},e.update_old=function(){return e.oldValue=e.item[e.field]},e.status_process=function(){return e.item[e.field]!==e.oldValue?(e.status="progress",e.$digest(),t.$broadcast("changes_to_save",e)):void 0}},link:function(e,t){var n,i,r;return t=$(t),i=t.find(".trigger"),r=t.find(".triggered"),n=t.find(".correct_answer_indicator"),t.find("span.placeholder").click(function(){return i.hide(),r.show().children().first().focus()}),t.find(".triggered > *").blur(function(){var t;return t=$(this),e.status_process(),""!==t.val()?(r.hide(),i.show()):void 0}),e.$watch("collection",function(t){var n,i,r,o;if(t){for(e.checked=t[0]._id,o=[],i=0,r=t.length;r>i;i++)n=t[i],n.correct===!0?o.push(e.checked=n._id):o.push(void 0);return o}}),e.$watch("item.content",function(t){return t?e.$parent.element_switch===!0?(i.show(),r.hide()):void 0:(i.hide(),r.show())}),e.$watch("item.correct_saved",function(t){return t===!0?(n.show(),setTimeout(function(){return n.hide(),e.$apply(e.item.correct_saved=!1)},1e3)):void 0},!0)}}}).directive("statusIndicator",function(){return{restrict:"E",replace:!0,require:"?ngModel",scope:{item:"=ngBinding",field:"=ngField"},template:'<div class="statuses">\n  <div class=\'preloader\' ng-show="item==\'progress\'"></div>\n  <div class="save_status" ng-show="item==\'done\'">\n    <i class="icon-ok-sign"></i>saved\n  </div>\n</div>',link:function(e){return e.$watch("item",function(t){return t?("progress"===t&&(e.progress_timeout=setTimeout(function(){return e.$apply(e.item="done")},500)),"done"===t?e.done_timeout=setTimeout(function(){return e.$apply(e.item="")},700):void 0):(clearTimeout(e.done_timeout),clearTimeout(e.progress_timeout))},!0),!0}}}).directive("audioplayer",function(){return{restrict:"E",replace:!0,require:"?ngModel",scope:{item:"=ngItem",help:"@ngHelp",id:"@ngId",title:"@ngTitle",field:"@ngField",parent:"=parent"},template:'<div class="form-group audio">\n  <label class="col-xs-2 control-label" for="audio">\n    Audio\n    <span class="label label-danger" ng-show="edit_mode">Fill to publish</span>\n  </label>\n  <div class="help">\n    <i class="icon-question-sign" data-content="Supplementary field. You may indicate the exhibit’s inventory, or any other number, that will help you to identify the exhibit within your own internal information system." data-placement="bottom"></i>\n  </div>\n  <div class="col-xs-9 trigger" ng-hide="edit_mode">\n    <div class="jp-jplayer" id="jquery_jplayer_{{id}}">\n    </div>\n    <div class="jp-audio" id="jp_container_{{id}}">\n      <div class="jp-type-single">\n        <div class="jp-gui jp-interface">\n          <ul class="jp-controls">\n            <li>\n            <a class="jp-play" href="javascript:;" tabindex="1"></a>\n            </li>\n            <li>\n            <a class="jp-pause" href="javascript:;" tabindex="1"></a>\n            </li>\n          </ul>\n        </div>\n        <div class="jp-timeline">\n          <div class="dropdown">\n            <a class="dropdown-toggle" data-toggle="dropdown" href="#" id="visibility_filter">{{item[field].name}}<span class="caret"></span></a>\n            <ul class="dropdown-menu" role="menu">\n              <li role="presentation">\n                <a href="#" class="replace_media" data-confirm="Are you sure you wish to replace this audio?" data-method="delete" data-link="{{$parent.$parent.backend_url}}/media/{{item[field]._id}}">Replace</a>\n              </li>\n              <li role="presentation">\n                <a href="{{item[field].url}}" target="_blank">Download</a>\n              </li>\n              <li role="presentation">\n                <a class="remove" href="#" data-confirm="Are you sure you wish to delete this audio?" data-method="delete" data-link="{{$parent.$parent.backend_url}}/media/{{media._id}}" delete-media="" stop-event="" media="item[field]" parent="item">Delete</a>\n              </li>\n            </ul>\n          </div>\n          <div class="jp-progress">\n            <div class="jp-seek-bar">\n              <div class="jp-play-bar">\n              </div>\n            </div>\n          </div>\n          <div class="jp-time-holder">\n            <div class="jp-current-time">\n            </div>\n            <div class="jp-duration">\n            </div>\n          </div>\n          <div class="jp-no-solution">\n            <span>Update Required</span>To play the media you will need to either update your browser to a recent version or update your browser to a recent version or update your <a href="http://get.adobe.com/flashplayer/" target="_blank"></a>\n          </div>\n        </div>\n      </div>\n    </div>\n  </div>\n  <div class="triggered" ng-show="edit_mode">\n    <a href="#" class="btn btn-default" button-file-upload="">Upload a file</a>\n    <span class="or_drag">or drag an audio here</span>\n  </div>\n  <status-indicator ng-binding="item" ng-field="field"></statusIndicator>\n</div>',link:function(e,t){return e.edit_mode=!1,t=$(t),t.find(".replace_media").click(function(e){var t,n,i;return e.preventDefault(),e.stopPropagation(),t=$(this),confirm(t.data("confirm"))?(i=t.parents("#drop_down, #museum_drop_down"),i.click(),n=i.find(".images :file"),n.click()):void 0}),e.$watch("item[field]",function(t){return t?(e.edit_mode=!1,$("#jquery_jplayer_"+e.id).jPlayer({cssSelectorAncestor:"#jp_container_"+e.id,swfPath:"/js",wmode:"window",preload:"auto",smoothPlayBar:!0,supplied:"mp3, ogg"}),$("#jquery_jplayer_"+e.id).jPlayer("setMedia",{mp3:t.url,ogg:t.thumbnailUrl})):e.edit_mode=!0}),!0}}}).directive("museumSearch",function(){return{restrict:"E",replace:!0,transclude:!0,require:"?ngModel",scope:{item:"=ngModel"},template:'<div class="searches">\n  <div class="search" ng-hide="museum_search_visible" ng-click="museum_search_visible=true; museum_input_focus = true">\n    <i class="icon-search"></i>\n    <a href="#">{{item || \'Search\'}}</a>\n  </div>\n  <div class="search_input" ng-show="museum_search_visible">\n    <input class="form-control" ng-model="item" placeholder="Search" type="text" focus-me="museum_input_focus">\n    <a class="search_reset" href="#" ng-click="item=\'\'">\n      <i class="icon-remove-sign"></i>\n    </a>\n  </div>\n</div>',controller:function(e,t){return e.museum_search_visible=!1,e.museum_input_focus=!1,$(t).find(".search_input input").blur(function(){var t;return t=$(this),e.$apply(e.museum_input_focus=!1),t.animate({width:"150px"},150,function(){return e.$apply(e.museum_search_visible=!1),!0})}),$(t).find(".search_input input").focus(function(){var e,t;return e=$(this),t=$("body").width()-700,t>150?e.animate({width:""+t+"px"},300):void 0})},link:function(){return!0}}}).directive("canDragAndDrop",function(){return{restrict:"A",scope:{model:"=model",url:"@uploadTo",selector:"@selector",selector_dropzone:"@selectorDropzone"},link:function(e,t){var n,i,r,o,s,a;return e.$parent.loading_in_progress=!1,o=50,t=$("#"+e.selector),r=$("#"+e.selector_dropzone),n=function(e){var t,n;return t=e.files[0].name.split(".").pop().toLowerCase(),n="unsupported",-1!==$.inArray(t,gon.acceptable_extensions.image)&&(n="image"),-1!==$.inArray(t,gon.acceptable_extensions.audio)&&(n="audio"),-1!==$.inArray(t,gon.acceptable_extensions.video)&&(n="video"),n},i=function(e){return e.files[0]&&e.files[0].size<1024*1024*o},s=function(){return $(".progress").hide(),setTimeout(function(){return $("body").removeClass("in"),e.$parent.loading_in_progress=!1,e.$parent.forbid_switch=!1},1e3)},a=function(){return e.$parent.loading_in_progress=!0,e.$parent.forbid_switch=!0,e.$digest(),$("body").addClass("in"),$(".progress .progress-bar").css("width","0%"),$(".progress").show()},t.fileupload({url:e.url,dataType:"json",dropZone:r,change:function(){return a()},drop:function(e,t){return a(),$.each(t.files,function(e,t){return console.log("Dropped file: "+t.name)})},add:function(t,r){var o,a;return a=n(r),"image"===a||"audio"===a||"video"===a?i(r)?(o=e.model._id,("audio"===a||"video"===a)&&(o=e.model.stories[e.$parent.current_museum.language]._id),r.formData={type:a,parent:o},r.submit()):(console.log("error: file size"),s()):(console.log("error: file type"),s())},success:function(t){var n,i,r,o;for(console.log(t,e.model),o=[],i=0,r=t.length;r>i;i++)n=t[i],"image"===n.type?(null==e.model.images&&(e.model.images=[]),e.$apply(e.model.images.push(n))):"audio"===n.type?e.$apply(e.model.stories[e.$parent.current_museum.language].audio=n):"video"===n.type&&e.$apply(e.model.stories[e.$parent.current_museum.language].video=n),o.push(e.$digest());return o},error:function(e,t,n){var i,r;return console.log(t,e,n),"abort"===n?console.log("abort"):422===e.status?(i=jQuery.parseJSON(e.responseText),r=i.link[0],console.log(r)):console.log("unknown error")},progressall:function(t,n){var i,r,o,a;return r=parseInt(100*(n.loaded/n.total),10),i=102.4,o=Math.round(n.bitrate/i)/10,a=""+o+" Кб/с",o>1e3&&(o=Math.round(o/i)/10,a=""+o+" Мб/с"),$(".progress .progress-text").html("&nbsp;&nbsp; Загружено "+Math.round(n.loaded/1024)+" Кб из "+Math.round(n.total/1024)+" Кб, скорость: "+a),$(".progress .progress-bar").css("width",r+"%"),n.loaded===n.total?(e.$parent.last_save_time=new Date,s()):void 0}}).prop("disabled",!$.support.fileInput).parent().addClass($.support.fileInput?void 0:"disabled"),e.$watch("url",function(e){return e?t.fileupload("option","url",e):void 0})}}}).directive("buttonFileUpload",function(){return{restrict:"A",link:function(e,t){var n;return n=$(t),n.click(function(e){var t;return e.preventDefault(),n=$(this),t=n.parents("#drop_down, #museum_edit_dropdown"),t.find(".images :file").click()})}}}).directive("deleteMedia",function(){return{restrict:"A",scope:{model:"=parent",media:"=media"},link:function(e,t){return t=$(t),t.click(function(t){var n;return t.preventDefault(),t.stopPropagation(),n=$(this),confirm(n.data("confirm"))?$.ajax({url:n.data("link"),type:n.data("method"),success:function(t){var n,i,r,o,s;if("image"===e.media.type)for(s=e.model.images,i=r=0,o=s.length;o>r;i=++r)n=s[i],null!=n&&n._id===t&&(e.$apply(e.model.images.splice(i,1)),e.$digest());else"audio"===e.media.type&&(e.model.audio=void 0,e.$digest());return e.$parent.last_save_time=new Date}}):void 0})}}}).directive("dragAndDropInit",function(){return{link:function(e){return $(document).bind("drop dragover",function(e){return e.preventDefault()}),$(document).bind("dragover",function(t){var n,i,r,o,s,a;for(i=$(".dropzone"),n=$("body"),a=e.dropZoneTimeout,a?clearTimeout(a):n.addClass("in"),r=!1,o=0,s=t.target;;){if(s===i[0]){r=!0,o=0;break}if(s===i[1]){r=!0,o=1;break}if(s=s.parentNode,null==s)break}return r?i[o].addClass("hover"):e.dropZoneTimeout=setTimeout(function(){return e.loading_in_progress?void 0:(e.dropZoneTimeout=null,i.removeClass("in hover"),n.removeClass("in"))},300)})}}}).directive("dropDownEdit",function(e,t){return{restrict:"A",link:function(e){var n,i,r,o,s;return s=null,o=null,i=null,n=null,r=null,e.$watch("active_exhibit.stories[current_museum.language]",function(a){return null!=s&&s(),null!=o&&o(),null!=i&&i(),null!=n&&n(),null!=r&&r(),null!=a?(s=e.$watch("active_exhibit.stories[current_museum.language].quiz",function(t,n){if(null!=t&&t!==n){if("published"===t.status)return console.log("pub"),$("#story_quiz_enabled").is(":checked")?setTimeout(function(){return $("#story_quiz_enabled").click()},10):setTimeout(function(){return e.quizform.$valid?void 0:setTimeout(function(){return $("#story_quiz_disabled").click()},10)},100);if(!$("#story_quiz_disabled").is(":checked"))return setTimeout(function(){return $("#story_quiz_disabled").click()},10)}}),o=e.$watch("active_exhibit.stories[current_museum.language].quiz.question",function(t,n){return null!=e.quizform&&t!==n?e.quizform.$valid?e.mark_quiz_validity(e.quizform.$valid):setTimeout(function(){return $("#story_quiz_disabled").click(),e.mark_quiz_validity(e.quizform.$valid)},10):void 0}),i=e.$watch("active_exhibit.stories[current_museum.language].name",function(t,n){var i;if(null!=t&&(i=$("#media form"),i.length>0))if("dummy"===e.active_exhibit.stories[e.current_museum.language].status){if(t)return e.active_exhibit.stories[e.current_museum.language].status="passcode"}else if(!e.new_item_creation&&!t)return e.active_exhibit.stories[e.current_museum.language].name=n,$(".empty_name_error.name").show(),setTimeout(function(){return $(".empty_name_error.name").hide()},1500)}),n=e.$watch(function(){return null!=e.active_exhibit.stories[e.current_museum.language]?angular.toJson(e.active_exhibit.stories[e.current_museum.language].quiz.answers):void 0},function(t){return null!=t&&null!=e.quizform?e.quizform.$valid?e.mark_quiz_validity(e.quizform.$valid):setTimeout(function(){return $("#story_quiz_disabled").click()},10):void 0}),r=e.$watch("active_exhibit.stories[current_museum.language]",function(n){return n&&!e.active_exhibit.stories[e.current_museum.language].qr_code?t.get(""+e.backend_url+"/qr_code/"+e.active_exhibit.stories[e.current_museum.language]._id).success(function(t){return e.active_exhibit.stories[e.current_museum.language].qr_code=t}):void 0})):void 0})}}}).directive("openLightbox",function(){return{restrict:"A",link:function(e,t,n){var i;return t=$(t),i=t.parents("#drop_down, #museum_edit_dropdown").find(".lightbox_area"),t.click(function(){return i.show(),i.find(".slider img.thumb.item_"+n.openLightbox).click()}),!0}}}).directive("lightboxCropper",function(e){return{restrict:"E",replace:!0,transclude:!0,scope:{model:"=model"},template:'<div class="lightbox_area">\n  <div class="explain_text">\n    Select the preview area. Images won\'t crop. You can always return to this later on.\n  </div>\n  <button class="btn btn-warning apply_resize" type="button">Done</button>\n  <div class="content">\n    <div class="preview">\n      PREVIEW\n      <div class="exhibit">\n        <div class="image">\n          <img src="{{model.images[active_image_index].url}}">\n        </div>\n        <div class="description">\n          <h4>\n            {{model.number}} {{model.stories[$parent.current_museum.language].name}}\n          </h4>\n        </div>\n      </div>\n    </div>\n    <div class="cropping_area">\n      <img src="{{model.images[active_image_index].url}}">\n    </div>\n  </div>\n  <div class="slider">\n    <a class="left" href="#" ng-click="set_index(active_imge_index - 1)">\n      <i class="icon-angle-left"></i>\n    </a>\n    <img class="thumb item_{{$index}}" ng-click="set_index($index)" ng-class="{\'active\':image.active}" src="{{image.thumbnailUrl}}" ng-repeat="image in model.images">\n    <a class="right" href="#" ng-click="set_index(active_image_index + 1)">\n      <i class="icon-angle-right"></i>\n    </a>\n  </div>\n</div>',controller:function(e){return e.set_index=function(t){return e.update_media(e.active_image_index,function(){return e.active_image_index=t,console.log(e.active_image_index,t)})},e.check_active_image=function(){var t,n,i,r,o,s;for(o=e.model.images,s=[],n=i=0,r=o.length;r>i;n=++i)t=o[n],s.push(t.active=n===e.active_image_index?!0:!1);return s}},link:function(t,n){var i,r,o,s,a,l,c,d,u,p,m,g,f,v;return n=$(n),g=n.find("a.right"),c=n.find("a.left"),r=n.find(".cropping_area img"),m=n.find(".exhibit .image img"),o=n.find(".apply_resize"),l=0,a=0,d=330,u=150,p=200,f={},i=[],o.click(function(){var e;return e=t.model.images[t.active_image_index],t.update_media(t.active_image_index,function(){var i;return i=t.model.images,i.sort(function(e,t){return e=new Date(e.updated),t=new Date(t.updated),t>e?1:e>t?-1:0}),t.model.images=i,"exhibit"===t.model.type&&$("ul.exhibits li.exhibit.active").find(".image img").attr("src",e.thumbnailUrl),n.hide()}),!1}),t.update_media=function(n,i){return e.put(""+t.$parent.backend_url+"/resize_thumb/"+t.model.images[t.active_image_index]._id,f).success(function(e){return console.log(e),t.model.images[n]=e,i&&i(),!0}).error(function(){return errorProcessing.addError("Failed to update a thumbnail"),!1})},v=function(e){var t,n;return f=e,t=200/f.w,n=150/f.h,m.css({width:Math.round(t*i[0])+"px",height:Math.round(n*i[1])+"px",marginLeft:"-"+Math.round(t*f.x)+"px",marginTop:"-"+Math.round(n*f.y)+"px"})},s=function(e){var t;return t=[e.x,e.y,e.x2,e.y2]},r.on("load",function(){var e,n;return l=r.get(0).naturalWidth,a=r.get(0).naturalHeight,r.height(d),r.width(l*(d/a)),m.attr("style",""),f=t.model.images[t.active_image_index].selection?JSON.parse(t.model.images[t.active_image_index].selection):{x:0,y:0,w:l,h:a,x2:l,y2:a},n={boxWidth:r.width(),boxHeight:r.height(),aspectRatio:4/3,setSelect:s(f),trueSize:[l,a],onChange:v,onSelect:v},this.jcrop&&this.jcrop.destroy(),e=null,r.Jcrop(n,function(){return e=this,i=e.getBounds()}),v(f),this.jcrop=e}),t.$watch("model.images",function(e){var n,i,r;if(null!=e&&e.length>0){for(i=0,r=e.length;r>i;i++)n=e[i],n.active=!1;return e[0].active=!0,c.css({opacity:0}),t.active_image_index=0}}),t.$watch("active_image_index",function(e){return null!=e?(c.css({opacity:255}),g.css({opacity:255}),e===t.model.images.length-1&&g.css({opacity:0}),0===e&&c.css({opacity:0}),t.check_active_image()):void 0}),!0}}}).directive("switchToggle",function(e){return{restrict:"A",controller:function(t,n,i,r,o){var s;return s=r.quizSwitch,t.quiz_state=function(n,i){return t.mark_quiz_validity(n.$valid),n.$valid?e(function(){return o.put(""+t.backend_url+"/quiz/"+i._id,i).success(function(e){return console.log(e)}).error(function(){return errorProcessing.addError("Failed to save quiz state")}),!0},0):setTimeout(function(){return $("#"+s+"_disabled").click()},300),!0},t.mark_quiz_validity=function(e){var t,n;return t=$("#"+s+" form"),e?t.removeClass("has_error"):(t.addClass("has_error"),n=t.find("#story_quiz_attributes_question, #museum_story_quiz_attributes_question"),""===n.val()&&n.addClass("ng-invalid")),!0}},link:function(e,t,n){var i;return i=n.quizSwitch,$("#"+i+"_enabled, #"+i+"_disabled").change(function(){var e;return e=$(this),e.attr("id")===""+i+"_enabled"?($("label[for="+i+"_enabled]").text("Enabled"),$("label[for="+i+"_disabled]").text("Disable"),!0):($("label[for="+i+"_disabled]").text("Disabled"),$("label[for="+i+"_enabled]").text("Enable"),!0)})}}}).directive("errorNotification",function(e){return{restrict:"E",replace:!0,transclude:!0,template:'<div class="error_notifications" ng-hide="errors.length == 0">\n  <div class="alert alert-danger" ng-repeat="error in errors">\n    {{error.error}}\n    <a class="close" href="#" ng-click="dismiss_error($index)" >&times;</a>\n  </div>\n</div>',link:function(t){return t.errors=e.getErrors(),t.dismiss_error=function(t){return e.deleteError(t)},t.$on("new_error",function(e,n){return t.errors=n})}}}).directive("scrollspyInit",function(){return{restrict:"A",link:function(e){var t;return t={target:$(".museum_edit_opener")},$("ul.exhibits").scrollspy({min:50,max:99999,onEnter:function(){return $(".float_menu").addClass("navbar-fixed-top"),$(".navigation").addClass("bottom-padding"),$(".to_top").show()},onLeave:function(){return $(".float_menu").removeClass("navbar-fixed-top"),$(".navigation").removeClass("bottom-padding"),$(".to_top").hasClass("has_position")?void 0:$(".to_top").hide()},onTick:function(){return e.museum_edit_dropdown_opened?e.show_museum_edit(t):void 0}})}}}).directive("toTop",function(){return{restrict:"E",replace:!0,transclude:!0,template:'<div class="to_top">\n  <div class="to_top_panel">\n    <div class="to_top_button" title="Наверх">\n      <span class="arrow"><i class="icon-long-arrow-up"></i></span>\n    </div>\n  </div>\n</div>',link:function(e,t){return t=$(t),t.click(function(){var e;return t.hasClass("has_position")?(t.removeClass("has_position"),e=t.data("scrollPosition"),t.find(".arrow i").removeClass("icon-long-arrow-down").addClass("icon-long-arrow-up"),$.scrollTo(e,0)):(t.addClass("has_position"),e=$(document).scrollTop(),t.data("scrollPosition",e),t.find(".arrow i").addClass("icon-long-arrow-down").removeClass("icon-long-arrow-up"),$.scrollTo(0,0))})}}})}).call(this);